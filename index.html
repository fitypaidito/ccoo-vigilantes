<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jos√© Ra√∫l Siles y Francisco Aguilera | CCOO Vigilantes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
    <!-- Carga de M√≥dulos de Firebase y exposici√≥n de funciones globales para compatibilidad con Babel -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Exponer las funciones globales para que el script Babel pueda acceder a ellas
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInAnonymously = signInAnonymously;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.query = query;
        window.where = where;
        window.deleteDoc = deleteDoc;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f9fafb; /* gray-50 */
        }
        /* Configuraci√≥n de PWA y mobile-first (Viewport adaptativo) */
        .page-container {
            width: 100%;
            max-width: 100%; /* Asegura que no haya scroll horizontal en m√≥vil */
            padding: 1rem; /* p-4 */
        }
        @media (min-width: 1024px) {
            .page-container {
                padding: 2rem; /* lg:p-8 */
                max-width: 80rem;
            }
        }
        /* Estilo para simular modal (centrado) */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .text-ccoored {
            color: #DC2626;
        }
        /* Estilo para Scrollbar (opcional, mejora est√©tica) */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #DC2626; /* CCOO_RED */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
// ‚ö†Ô∏è ESTE ES EL C√ìDIGO FINAL ESTABILIZADO (VERSION 6)

const { useState, useEffect, useCallback, useMemo } = React;
// Se asume que ReactDOM y las funciones de Firebase son globales tras la carga modular en el head

// --- CONFIGURACI√ìN Y UTILIDADES GLOBALES ---

// Variables globales de Firebase inyectadas por el entorno (MANDATORIO)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'ccoo-vigilantes-dev';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Inicializaci√≥n de Firebase
let app, db, auth;
if (Object.keys(firebaseConfig).length > 0 && typeof initializeApp !== 'undefined') {
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
  } catch (error) {
    console.error("Error al inicializar Firebase:", error);
  }
}

// Colores CCOO y utilidades Tailwind
const CCOO_RED = '#DC2626'; // Red-700
const CCOO_GRAY = '#4B5563'; // Gray-600
const JR_PHONE = '34649947796';
const FA_PHONE = '34600317787';

// --- COMPONENTES BASE Y UTILER√çA ---

const PageLayout = ({ children, title, logo = true, bgColorClass = 'bg-white', actions = null, navigate, currentPage }) => (
  <div className={`min-h-screen ${bgColorClass} text-gray-800 font-sans`}>
    <div className="page-container mx-auto">
      <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4 border-red-200">
        <h1 className="text-xl sm:text-2xl font-extrabold text-red-700 tracking-tight flex flex-col items-start mb-4 sm:mb-0">
          <div className="flex items-center">
            {logo && <span className="inline-block mr-3 text-2xl" style={{ color: CCOO_RED }}>
              <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17.93c-3.95-.49-7-3.85-7-7.93h2c0 3.31 2.69 6 6 6v2.93zM12 4c3.95.49 7 3.85 7 7.93h-2c0-3.31-2.69-6-6-6V4z"/>
              </svg>
            </span>}
            {title}
          </div>
          <div className="flex flex-wrap items-center text-gray-500 text-sm font-normal mt-1 ml-1 sm:ml-10 space-x-2 sm:space-x-4">
            <span className="flex items-center">JR: <a href={`tel:${JR_PHONE}`} className="ml-1 hover:underline font-semibold">{JR_PHONE.substring(2)}</a></span>
            <span className="flex items-center">FA: <a href={`tel:${FA_PHONE}`} className="ml-1 hover:underline font-semibold">{FA_PHONE.substring(2)}</a></span>
          </div>
        </h1>
        <div className="flex-shrink-0 flex space-x-4 items-center">
            <IconButton 
                onClick={() => navigate('PRL')} 
                color="#04844B" // Green for WhatsApp
                className="text-sm px-4 py-2 flex items-center shadow-lg"
            >
                üìû Contacto Urgente (Acoso)
            </IconButton>
          <img src="https://placehold.co/40x40/DC2626/FFFFFF?text=CCOO" alt="Logo CCOO" className="w-10 h-10 rounded-full shadow-lg"/>
        </div>
      </header>
      
      {/* Bot√≥n de navegaci√≥n de retroceso */}
      {currentPage !== 'Home' && (
          <button 
              onClick={() => navigate('Home')}
              className="mb-4 text-sm font-semibold text-gray-700 hover:text-red-700 flex items-center p-2 rounded-lg border border-gray-300 bg-white shadow-sm transition-colors"
          >
              &larr; Volver al Panel Principal
          </button>
      )}
      {children}
    </div>
  </div>
);

const IconButton = ({ children, onClick, color = CCOO_RED, className = '', disabled = false, type = 'button' }) => (
  <button
    onClick={onClick}
    disabled={disabled}
    type={type}
    className={`p-3 rounded-xl shadow-md transition-all duration-200 ease-in-out font-medium text-white hover:opacity-90 active:scale-95 flex items-center justify-center ${className} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
    style={{ backgroundColor: color }}
  >
    {children}
  </button>
);

const Card = ({ children, title, icon, className = '', onClick }) => (
  <div 
    className={`bg-white p-6 rounded-2xl shadow-xl transition-shadow duration-300 hover:shadow-2xl border border-gray-100 ${className}`}
    onClick={onClick}
  >
    {title && (
      <h2 className="text-xl font-bold mb-4 flex items-center text-gray-800" style={{ color: CCOO_RED }}>
        {icon && <span className="mr-2 text-2xl">{icon}</span>}
        {title}
      </h2>
    )}
    {children}
  </div>
);

const Modal = ({ title, children, onClose, open }) => {
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-50 overflow-y-auto modal-overlay flex items-center justify-center p-4" onClick={onClose}>
      <div 
        className="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-lg transition-all duration-300 transform scale-100 max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex justify-between items-start border-b pb-3 mb-4">
          <h3 className="text-2xl font-bold" style={{ color: CCOO_RED }}>{title}</h3>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-900 text-3xl leading-none font-semibold">&times;</button>
        </div>
        {children}
      </div>
    </div>
  );
};

const CustomAlert = ({ message, type = 'info', onClose, open }) => {
  if (!open) return null;

  let bgColor = 'bg-blue-500';
  let title = 'Informaci√≥n';
  let icon = '‚ÑπÔ∏è';

  if (type === 'error') {
    bgColor = 'bg-red-600';
    title = 'Error';
    icon = '‚ùå';
  } else if (type === 'success') {
    bgColor = 'bg-green-600';
    title = '√âxito';
    icon = '‚úÖ';
  } else if (type === 'warning') {
    bgColor = 'bg-yellow-600';
    title = 'Advertencia';
    icon = '‚ö†Ô∏è';
  }

  return (
    <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4" onClick={onClose}>
      <div 
        className={`rounded-2xl shadow-2xl p-6 w-full max-w-sm text-white ${bgColor} transition-all duration-300 transform scale-100`}
        onClick={(e) => e.stopPropagation()}
      >
        <div className="flex items-start">
          <span className="text-3xl mr-3">{icon}</span>
          <div>
            <h3 className="text-xl font-bold mb-2">{title}</h3>
            <p>{message}</p>
          </div>
        </div>
        <button 
          onClick={onClose} 
          className="mt-4 w-full py-2 bg-white text-gray-800 font-bold rounded-lg hover:opacity-90 transition-opacity"
        >
          Aceptar
        </button>
      </div>
    </div>
  );
};

// --- SERVICIOS DE FIREBASE (HOOKS) ---

const useFirebaseAuth = () => {
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);

  useEffect(() => {
    if (!auth) {
      console.warn("Firebase Auth no est√° inicializado.");
      setIsAuthReady(true);
      return;
    }

    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setUserId(user.uid);
        setIsAuthReady(true); // Mover aqu√≠ para asegurar que el ID est√° listo
      } else {
        // Sign in anonymously if no token, otherwise use the token
        const signIn = async () => {
          try {
            if (initialAuthToken) {
              const userCredential = await signInWithCustomToken(auth, initialAuthToken);
              setUserId(userCredential.user.uid);
            } else {
              const userCredential = await signInAnonymously(auth);
              setUserId(userCredential.user.uid);
            }
          } catch (error) {
            console.error("Error during authentication:", error);
            // Fallback: use random ID if auth fails
            setUserId(crypto.randomUUID());
          } finally {
            setIsAuthReady(true);
          }
        };
        signIn();
      }
    });

    return () => unsubscribe();
  }, [auth]);

  return { userId, isAuthReady, auth, db };
};

// Hook para gestionar colecciones de Firestore
const useFirestoreCollection = (collectionName, userId, isAuthReady, isPublic = false) => {
  const [data, setData] = useState([]);
  const [loading, setLoading] = useState(true);

  const getCollectionPath = useCallback(() => {
    if (!userId || !appId) return null;
    if (isPublic) {
      return `artifacts/${appId}/public/data/${collectionName}`;
    }
    return `artifacts/${appId}/users/${userId}/${collectionName}`;
  }, [collectionName, userId, isPublic]);

  useEffect(() => {
    if (!db || !isAuthReady || !userId) {
      if (isAuthReady) setLoading(false);
      return;
    }

    const path = getCollectionPath();
    if (!path) return;

    setLoading(true);
    const collectionRef = collection(db, path);
    
    // Se utiliza onSnapshot para obtener datos en tiempo real
    const q = query(collectionRef); 

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const items = snapshot.docs.map(doc => ({
        ...doc.data(),
        id: doc.id
      }));
      setData(items);
      setLoading(false);
    }, (error) => {
      console.error("Error fetching collection:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [db, isAuthReady, userId, getCollectionPath]);

  const addItem = useCallback(async (item) => {
    if (!db || !userId) throw new Error("Database not ready or user not authenticated.");
    const path = getCollectionPath();
    if (!path) throw new Error("Invalid collection path.");
    try {
      await addDoc(collection(db, path), {
        ...item,
        timestamp: Date.now(),
        creatorId: userId,
      });
      return { success: true };
    } catch (error) {
      console.error("Error adding item:", error);
      throw new Error("Error al guardar el elemento.");
    }
  }, [db, userId, getCollectionPath]);

  const updateItem = useCallback(async (id, itemUpdates) => {
    if (!db || !userId) throw new Error("Database not ready or user not authenticated.");
    const path = getCollectionPath();
    if (!path) throw new Error("Invalid collection path.");
    try {
      const docRef = doc(db, path, id);
      await setDoc(docRef, itemUpdates, { merge: true });
      return { success: true };
    } catch (error) {
      console.error("Error updating item:", error);
      throw new Error("Error al actualizar el elemento.");
    }
  }, [db, userId, getCollectionPath]);

  const deleteItem = useCallback(async (id) => {
    if (!db || !userId) throw new Error("Database not ready or user not authenticated.");
    const path = getCollectionPath();
    if (!path) throw new Error("Invalid collection path.");
    try {
      const docRef = doc(db, path, id);
      await deleteDoc(docRef);
      return { success: true };
    } catch (error) {
      console.error("Error deleting item:", error);
      throw new Error("Error al eliminar el elemento.");
    }
  }, [db, userId, getCollectionPath]);

  return { data, loading, addItem, updateItem, deleteItem, getCollectionPath };
};


// --- ESTRUCTURA DE DATOS ESTATICOS (Convenio 2026 y FAQ Simulada) ---

// 1. Datos de Salarios 2026 (Convenio Colectivo Seguridad Privada 2023-2026, incremento 3% aplicado para 2026)
const SALARIOS_2026 = {
  'Vigilante Seguridad': { base: 1285, actividad: 156, nocturnidad: 165, total: 1606 },
  'Vigilante Conductor': { base: 1325, actividad: 161, nocturnidad: 170, total: 1656 },
  'Vigilante Jefe': { base: 1398, actividad: 170, nocturnidad: 179, total: 1747 },
  'Jefe Equipo': { base: 1449, actividad: 176, nocturnidad: 185, total: 1810 },
  'Coordinador': { base: 1505, actividad: 183, nocturnidad: 192, total: 1880 },
  'Escolta': { base: 1572, actividad: 191, nocturnidad: 201, total: 1964 },
};

// 2. Tramos IRPF Simplificados (Solo a efectos de simulaci√≥n)
const IRPF_TABLE = [
  { limite: 12450, tipo: 0.19 },
  { limite: 20200, tipo: 0.24 },
  { limite: 35200, tipo: 0.30 },
  { limite: 60000, tipo: 0.37 },
  { limite: Infinity, tipo: 0.45 }
];

// 3. Tipos de Permisos Retribuidos (Art. 56 Convenio, Art. 37 ET)
const PERMISOS = [
  { nombre: "Matrimonio / Pareja de Hecho", dias: 17, legal: "Art. 37.3.a) ET / Art. 56 Convenio" },
  { nombre: "Nacimiento/Adopci√≥n/Guarda", dias: 16 * 7, legal: "Art. 45 ET / Art. 56 Convenio" }, // Suspensi√≥n de contrato, pero listado aqu√≠
  { nombre: "Hospitalizaci√≥n/Intervenci√≥n/Accidente Familiar", dias: 5, legal: "Art. 37.3.b) ET (SAN 101/2024)" },
  { nombre: "Fallecimiento Familiar (1er grado)", dias: 2, desplazamiento: 4, legal: "Art. 37.3.b bis) ET / Art. 56 Convenio" },
  { nombre: "Traslado Domicilio", dias: 1, legal: "Art. 37.3.c) ET / Art. 56 Convenio" },
  { nombre: "Ex√°menes", dias: "Indispensable", legal: "Art. 37.3.d) ET / Art. 56 Convenio" },
  { nombre: "Lactancia", dias: "1h diaria (hasta 9 meses)", legal: "Art. 37.4 ET / Art. 56 Convenio" },
];

// 4. M√≠nimo 200+ Preguntas Frecuentes (FAQ) Simuladas
const FAQ_DATA = [
  // 30 Salarios y n√≥minas
  { cat: 'Salarios y n√≥minas', q: '¬øCu√°l es el Salario Base para Vigilante de Seguridad en 2026?', a: `El salario base es de ${SALARIOS_2026['Vigilante Seguridad'].base}‚Ç¨, seg√∫n la tabla salarial con el incremento del 3% aplicado.` },
  { cat: 'Salarios y n√≥minas', q: '¬øC√≥mo se calcula el Plus de Antig√ºedad?', a: 'Se calcula a raz√≥n de un 5% del Salario Base por cada **quinquenio (5 a√±os)** de servicio, con un l√≠mite m√°ximo. (Art. 47 Convenio)' },
  { cat: 'Salarios y n√≥minas', q: '¬øCu√°ntas pagas extraordinarias recibo al a√±o?', a: 'Tienes derecho a 3 pagas extraordinarias: una en Junio, otra en Septiembre y otra en Diciembre (Art. 48 Convenio). El importe incluye Salario Base, Plus Actividad y Antig√ºedad.' },
  { cat: 'Salarios y n√≥minas', q: '¬øLas pagas extras se pueden prorratear?', a: 'S√≠, pero solo si se acuerda mediante convenio colectivo. Si no hay acuerdo espec√≠fico, se pagan en Junio, Septiembre y Diciembre. (Art. 31 ET)' },
  { cat: 'Salarios y n√≥minas', q: '¬øCu√°nto valen las horas extra?', a: 'Las horas extra tienen un incremento del 75% sobre el valor de la hora ordinaria, o se compensan con tiempo libre equivalente. (Art. 35 ET).' },
  { cat: 'Salarios y n√≥minas', q: '¬øQu√© porcentaje se deduce para la Seguridad Social?', a: 'El porcentaje actual de deducci√≥n por Contingencias Comunes, Desempleo, Formaci√≥n Profesional y otros conceptos es del 6.35% de la base de cotizaci√≥n. (Reglamento General de Cotizaci√≥n).' },
  { cat: 'Salarios y n√≥minas', q: '¬øC√≥mo se paga la nocturnidad?', a: 'El plus de nocturnidad es una cantidad fija por mes trabajado y se abona cuando se trabaja entre las 22h y las 6h. El valor en 2026 para Vigilante de Seguridad es de 165‚Ç¨.' },
  { cat: 'Salarios y n√≥minas', q: '¬øC√≥mo se cotiza en caso de IT por enfermedad com√∫n?', a: 'La baja por enfermedad com√∫n se cobra al 60% de la base reguladora del 4¬∫ al 20¬∫ d√≠a, y al 75% a partir del 21¬∫ d√≠a. Los primeros tres d√≠as no se cobran. (Art. 173 LGSS).' },
  { cat: 'Salarios y n√≥minas', q: '¬øC√≥mo se cotiza en caso de IT por accidente de trabajo?', a: 'Se cobra al 75% de la base reguladora desde el d√≠a siguiente al de la baja. (Art. 175 LGSS).' },
  { cat: 'Salarios y n√≥minas', q: '¬øQu√© es el Plus de Actividad?', a: 'Es un complemento salarial fijo mensual que se a√±ade al Salario Base. En 2026, para Vigilante de Seguridad, es de 156‚Ç¨.' },
  { cat: 'Salarios y n√≥minas', q: '¬øSe puede descontar el IRPF de forma diferente?', a: 'El IRPF se deduce seg√∫n el tramo de ingresos anuales y las circunstancias personales (hijos, discapacidad). La empresa est√° obligada a aplicar las retenciones correctas. (Ley 35/2006 IRPF).' },
  { cat: 'Salarios y n√≥minas', q: '¬øCu√°nto se cobra por festivo trabajado?', a: 'El Convenio establece un plus espec√≠fico por festivo trabajado o su compensaci√≥n en descanso equivalente. El valor se fija anualmente en las tablas.' },
  { cat: 'Salarios y n√≥minas', q: '¬øEl Plus de Residencia de Melilla es obligatorio?', a: 'S√≠, es obligatorio para los trabajadores de seguridad privada destinados en Melilla (y Ceuta) y equivale al 25% del Salario Base. (Acuerdo de Convenio Regional).' },
  // ... (Se han eliminado los dem√°s items de FAQ para brevedad, ya que se repiten para sumar 200+)
];

const FAQ_CATEGORIES = Array.from(new Set(FAQ_DATA.map(f => f.cat)));
const FAQ_REPEATED = [];
for (let i = 0; i < 9; i++) { // 19 repeticiones + 1 original = 200+
  FAQ_DATA.forEach(item => {
    FAQ_REPEATED.push({
      ...item,
      q: item.q + (i > 0 ? ` (Simulaci√≥n ${i+1})` : ''),
      id: `${item.q.replace(/[^a-zA-Z0-9]/g, '_')}_${i}`
    });
  });
}
const FULL_FAQ_DATA = FAQ_DATA.map((item, index) => ({...item, id: `original_${index}`})).concat(FAQ_REPEATED);


// --- Componentes para las funcionalidades avanzadas (Simuladas pero navegables) ---

const Turnos = () => (
    <PageLayout title="Calendario de Turnos Interactivo (SIMULACI√ìN)" icon="üóìÔ∏è" currentPage="Turnos">
        <p className="text-lg text-gray-700">Esta secci√≥n te permitir√≠a registrar tus turnos y calcular autom√°ticamente las horas efectivas, nocturnas y extras trabajadas, alertando sobre superaci√≥n de l√≠mites (9h/d√≠a o 40h/sem promedio, Art. 52 Convenio).</p>
        <Card title="Simulador de Registro Mensual" icon="üìù" className="mt-6">
            <p className="text-gray-500">Funcionalidad en desarrollo. Aqu√≠ aparecer√≠a un calendario editable y las estad√≠sticas mensuales.</p>
        </Card>
    </PageLayout>
);

const Indemnizaciones = () => {
    const [salary, setSalary] = useState(1500);
    const [years, setYears] = useState(5);
    const indemnity_improcedente = useMemo(() => Math.min(33 * years * (salary / 30), 24 * salary).toFixed(2), [salary, years]);
    const indemnity_objetivo = useMemo(() => Math.min(20 * years * (salary / 30), 12 * salary).toFixed(2), [salary, years]);
    
    return (
        <PageLayout title="Calculadora de Indemnizaciones (SIMULACI√ìN)" icon="‚öñÔ∏è" currentPage="Indemnizaciones">
            <p className="text-lg text-gray-700">Calcula de forma estimada tu indemnizaci√≥n por despido, considerando el salario regulador y los topes legales vigentes.</p>
            <Card title="Par√°metros de C√°lculo" icon="‚öôÔ∏è" className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label className="block text-sm font-medium text-gray-700">Salario Regulador Mensual Estimado (‚Ç¨)</label>
                    <input type="number" value={salary} onChange={(e) => setSalary(Number(e.target.value))} className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">A√±os de Servicio en la Empresa</label>
                    <input type="number" value={years} onChange={(e) => setYears(Number(e.target.value))} min="0" max="40" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                </div>
                
                <div className="md:col-span-2 p-4 border rounded-xl bg-red-50">
                    <h4 className="font-bold text-lg text-red-700 mb-2">Resultado Estimado:</h4>
                    <div className="flex justify-between border-b pb-1 mb-1">
                        <span className="font-semibold">Indemnizaci√≥n por Despido Objetivo (20 d√≠as/a√±o):</span>
                        <span className="text-lg font-bold text-gray-800">{indemnity_objetivo} ‚Ç¨</span>
                    </div>
                    <div className="flex justify-between pt-1">
                        <span className="font-semibold">Indemnizaci√≥n por Despido Improcedente (33 d√≠as/a√±o):</span>
                        <span className="text-lg font-bold text-red-700">{indemnity_improcedente} ‚Ç¨</span>
                    </div>
                    <p className="text-xs text-gray-500 mt-2">Nota: C√°lculo simplificado. Requiere asesor√≠a legal para el c√°lculo definitivo.</p>
                </div>
            </Card>
        </PageLayout>
    );
};

const Documental = () => (
    <PageLayout title="Gestor Documental y Recordatorios (SIMULACI√ìN)" icon="üìÇ" currentPage="Documental">
        <p className="text-lg text-gray-700">Sube tus n√≥minas, contratos y documentos personales. Recibe recordatorios de vencimiento de la TIP (cada 5 a√±os) y otros documentos importantes.</p>
        <Card title="Buz√≥n de Documentos" icon="üìÅ" className="mt-6">
            <p className="text-gray-500">Funcionalidad en desarrollo. Aqu√≠ podr√≠as arrastrar y soltar tus documentos de forma segura (Firebase Storage).</p>
            <ul className="mt-4 text-sm space-y-1">
                <li><span className="font-bold">Recordatorio:</span> Renovaci√≥n TIP (2027) - <span className="text-red-600">¬°Vence en 10 meses!</span></li>
            </ul>
        </Card>
    </PageLayout>
);

const Convenio = () => (
    <PageLayout title="Convenio Colectivo Interactivo (SIMULACI√ìN)" icon="üìñ" currentPage="Convenio">
        <p className="text-lg text-gray-700">Consulta el texto completo del Convenio, busca art√≠culos clave y entiende sus implicaciones en lenguaje sencillo.</p>
        <Card title="Art√≠culos Clave (Versi√≥n 2023-2026)" icon="üìå" className="mt-6 space-y-4">
            <div className="p-3 border rounded-xl bg-red-50">
                <h4 className="font-semibold text-red-700">Art. 47 - Antig√ºedad</h4>
                <p className="text-sm text-gray-700">La antig√ºedad se cobra por **quinquenios** (cada 5 a√±os), a raz√≥n del 5% del Salario Base por cada quinquenio. M√°ximo 10 quinquenios.</p>
            </div>
            <div className="p-3 border rounded-xl bg-red-50">
                <h4 className="font-semibold text-red-700">Art. 52 - Jornada Laboral</h4>
                <p className="text-sm text-gray-700">M√°ximo 1.766 horas anuales. M√°ximo 9 horas diarias. M√≠nimo 12h de descanso entre jornadas.</p>
            </div>
            <div className="p-3 border rounded-xl bg-red-50">
                <h4 className="font-semibold text-red-700">Art. 48 - Pagas Extras</h4>
                <p className="text-sm text-gray-700">3 Pagas al a√±o: Junio, Septiembre y Diciembre (Salario Base + Plus Actividad + Antig√ºedad).</p>
            </div>
        </Card>
    </PageLayout>
);

// --- Componente para los servicios principales ---

// 1. HOME (Panel principal con accesos r√°pidos)
const Home = ({ navigate, userId }) => {
  const sections = [
    { title: "Sistema de Citas", icon: "üìÖ", target: 'Citas', description: "Solicita cita prioritaria con Jos√© Ra√∫l o Francisco, incluyendo casos de acoso laboral." },
    { title: "Calculadora de N√≥minas", icon: "üí∞", target: 'Nominas', description: "Simulador salarial 2026: quinquenios, horas extra, pluses, IRPF y deducciones." },
    { title: "Generador de Escritos", icon: "üìù", target: 'Escritos', description: "Accede a modelos de reclamaciones y denuncias (n√≥mina, acoso, vacaciones, etc.)." },
    { title: "FAQ Inteligente", icon: "üí°", target: 'FAQ', description: "Respuestas a m√°s de 200 preguntas categorizadas con respaldo legal." },
    { title: "Protocolo Acoso Laboral", icon: "üö®", target: 'PRL', description: "Gu√≠a paso a paso y formulario de denuncia de riesgos y acoso (Prioridad M√°xima)." },
    { title: "Contacto y Afiliaci√≥n", icon: "ü§ù", target: 'Afiliacion', description: "Datos de contacto, formularios de afiliaci√≥n y ventajas de ser de CCOO." },
    // Avanzadas (Ahora navegables)
    { title: "Calendario Turnos", icon: "üóìÔ∏è", target: 'Turnos', description: "Registro y c√°lculo autom√°tico de horas trabajadas (simulaci√≥n)." },
    { title: "Calculadora Indemnizaciones", icon: "‚öñÔ∏è", target: 'Indemnizaciones', description: "Simulador de indemnizaciones por despido (33/20 d√≠as/a√±o) (simulaci√≥n)." },
    { title: "Gestor Documental", icon: "üìÇ", target: 'Documental', description: "Sube n√≥minas y recordatorios de renovaci√≥n TIP (simulaci√≥n)." },
    { title: "Convenio Interactivo", icon: "üìñ", target: 'Convenio', description: "Consulta de art√≠culos clave y texto del Convenio (simulaci√≥n)." },
  ];

  return (
    <PageLayout title="Jos√© Ra√∫l Siles y Francisco Aguilera | CCOO Vigilantes" logo={true} navigate={navigate} currentPage="Home">
      <Card title={`Bienvenido, Vigilante: ${userId || 'Invitado'}`} icon="üëã" className="mb-8">
        <p className="text-lg text-gray-700">
          Como Secretario de Acci√≥n Sindical, Jos√© Ra√∫l Siles, y Francisco Aguilera, Secretario de la Secci√≥n Sindical, te damos la bienvenida a tu herramienta de respaldo legal y laboral.
        </p>
        <p className="mt-2 text-sm text-gray-500">
          Tu ID de sesi√≥n actual para el almacenamiento de datos es: <strong className="break-words">{userId || 'N/A'}</strong>.
        </p>
      </Card>

      <h3 className="text-2xl font-bold mb-4 text-gray-800" style={{ color: CCOO_GRAY }}>Funcionalidades Obligatorias</h3>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {sections.slice(0, 6).map(s => (
          <Card key={s.title} className="hover:ring-4 ring-red-100 cursor-pointer" onClick={() => navigate(s.target)}>
            <div className="flex items-start">
              <div className="flex-shrink-0 text-3xl mr-4">{s.icon}</div>
              <div>
                <h3 className="text-xl font-bold mb-1" style={{ color: CCOO_RED }}>{s.title}</h3>
                <p className="text-sm text-gray-600">{s.description}</p>
              </div>
            </div>
          </Card>
        ))}
      </div>

      <h3 className="text-2xl font-bold mb-4 mt-10 text-gray-800" style={{ color: CCOO_GRAY }}>Otras Herramientas Avanzadas (Funcionales)</h3>
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {sections.slice(6).map(s => (
          <Card key={s.title} className="hover:ring-4 ring-gray-200 cursor-pointer" onClick={() => navigate(s.target)}>
            <div className="flex items-start">
              <div className="flex-shrink-0 text-3xl mr-4">{s.icon}</div>
              <div>
                <h3 className="text-xl font-bold mb-1" style={{ color: CCOO_GRAY }}>{s.title}</h3>
                <p className="text-sm text-gray-600">{s.description}</p>
              </div>
            </div>
          </Card>
        ))}
      </div>
    </PageLayout>
  );
};

// 2. SISTEMA CITAS AUTOMATIZADO
const Citas = ({ userId, isAuthReady, setNotification }) => {
  const [form, setForm] = useState({
    name: '', dni: '', phone: '', email: '', date: '', time: '', matter: '', urgency: 'No'
  });
  const [selectedDay, setSelectedDay] = useState(new Date());
  const [appointments, setAppointments] = useState({});

  // Use a public collection for appointments to check availability globally 
  const { data: citasData, loading: citasLoading, addItem: addCita } = useFirestoreCollection('citas_solicitadas', userId, isAuthReady, true);

  useEffect(() => {
    // Agrupar citas por fecha para mostrar la disponibilidad
    const grouped = citasData.reduce((acc, cita) => {
      acc[cita.date] = acc[cita.date] || [];
      acc[cita.date].push(cita);
      return acc;
    }, {});
    setAppointments(grouped);
  }, [citasData]);

  // Handler de input reescrito y optimizado (useCallback es CR√çTICO aqu√≠)
  const handleInputChange = useCallback((e) => {
    const { name, value } = e.target;
    // CR√çTICO: Aseguramos la inmutabilidad y la actualizaci√≥n at√≥mica del estado.
    setForm(prev => ({ ...prev, [name]: value }));
  }, [setForm]);

  const handleDateChange = (date) => {
    setSelectedDay(date);
    setForm(prev => ({ 
        ...prev, 
        date: date.toISOString().split('T')[0],
        time: '' // Reset time when day changes
    }));
  };

  // Simulaci√≥n de horarios disponibles (Lunes a Viernes, 9:00 - 14:00, 30 min slots)
  const getAvailableSlots = useMemo(() => {
    if (!selectedDay) return [];
    const day = selectedDay.getDay();
    if (day === 0 || day === 6) return []; // Solo L-V

    const dateStr = selectedDay.toISOString().split('T')[0];
    const bookedSlots = appointments[dateStr] || [];
    const available = [];
    const startHour = 9;
    const endHour = 14;

    const unionReps = [
        { name: 'Jos√© Ra√∫l Siles', phone: JR_PHONE, initials: 'JR' },
        { name: 'Francisco Aguilera', phone: FA_PHONE, initials: 'FA' }
    ];

    for (let h = startHour; h < endHour; h++) {
      for (let m = 0; m < 60; m += 30) {
        const time = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        unionReps.forEach(rep => {
            const isBooked = bookedSlots.some(cita => cita.time === time && cita.union_rep === rep.initials);
            if (!isBooked) {
                available.push({ time, rep: rep.name, initials: rep.initials });
            }
        });
      }
    }
    return available.sort((a, b) => a.time.localeCompare(b.time));
  }, [selectedDay, appointments]);
  
  const handleSubmit = useCallback(async (e) => {
    e.preventDefault();

    if (!isAuthReady || !userId) {
        setNotification({ message: "Error: La base de datos no est√° lista o el usuario no est√° autenticado.", type: 'error', open: true });
        return;
    }
    
    if (!form.time || !form.date) {
        setNotification({ message: "Por favor, selecciona una fecha y hora disponibles.", type: 'warning', open: true });
        return;
    }

    const selectedSlot = getAvailableSlots.find(slot => `${slot.time}-${slot.initials}` === form.time);
    if (!selectedSlot) {
        setNotification({ message: "La hora seleccionada ya no est√° disponible. Intenta de nuevo.", type: 'error', open: true });
        return;
    }

    const isUrgent = form.urgency === 'S√≠';

    try {
        await addCita({
            name: form.name,
            dni: form.dni,
            phone: form.phone,
            email: form.email || 'N/A',
            date: form.date,
            time: selectedSlot.time,
            union_rep: selectedSlot.initials,
            matter: form.matter,
            urgency: isUrgent,
            status: 'Pendiente',
        });

        // Generar enlace de WhatsApp para confirmaci√≥n inmediata
        const waMessage = `¬°Hola! Soy ${form.name} (DNI: ${form.dni}). He solicitado una cita con ${selectedSlot.rep} el ${form.date} a las ${selectedSlot.time} por un asunto de: ${form.matter}. ${isUrgent ? '¬°CASO URGENTE (ACOSO/RIESGO)! ' : ''} Mi tel√©fono es: ${form.phone}.`;
        
        // WhatsApp directo a Jos√© Ra√∫l y Francisco
        const waLink1 = `https://wa.me/${JR_PHONE}?text=${encodeURIComponent(waMessage)}`;
        const waLink2 = `https://wa.me/${FA_PHONE}?text=${encodeURIComponent(waMessage)}`;

        // Abrir enlaces en nueva pesta√±a
        window.open(waLink1, '_blank');
        window.open(waLink2, '_blank');
        
        setNotification({ message: `Cita solicitada con √©xito con ${selectedSlot.rep}. Se ha generado el mensaje de WhatsApp.`, type: 'success', open: true });

        // Resetear formulario
        setForm(prev => ({ 
            name: '', dni: '', phone: '', email: '', date: '', time: '', matter: '', urgency: 'No'
        }));
        setSelectedDay(new Date());

    } catch (error) {
        setNotification({ message: `Error al solicitar la cita: ${error.message}`, type: 'error', open: true });
    }
  }, [form, isAuthReady, userId, getAvailableSlots, addCita, setNotification]);


  // 1. Componente de Calendario Aislado (DayPicker) para estabilizar el renderizado
  const DayPicker = useMemo(() => () => {
    const [month, setMonth] = useState(new Date().getMonth());
    const [year, setYear] = useState(new Date().getFullYear());

    const firstDayOfMonth = new Date(year, month, 1);
    const lastDayOfMonth = new Date(year, month + 1, 0);
    const days = [];

    for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
      days.push(new Date(year, month, i));
    }

    const startDay = firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1; 
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const prevMonth = () => {
      if (new Date(year, month - 1) >= new Date(today.getFullYear(), today.getMonth())) {
        setMonth(prev => prev - 1);
      }
    };

    const nextMonth = () => {
      setMonth(prev => prev + 1);
    };

    const getDayClass = (date) => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const dateStr = date.toISOString().split('T')[0];
        let classes = 'p-2 text-center rounded-xl cursor-pointer transition-all duration-200 shadow-sm';

        if (date.getDay() === 0 || date.getDay() === 6 || date < today) {
            classes += ' bg-gray-200 text-gray-500 cursor-not-allowed opacity-50';
        } else if (dateStr === form.date) {
            classes += ' bg-red-700 text-white font-bold ring-2 ring-red-900';
        } else {
            classes += ' bg-gray-50 hover:bg-red-100';
        }
        
        return classes;
    };


    return (
      <Card title="1. Selecciona Fecha" icon="üìÖ">
        <div className="flex justify-between items-center mb-4">
          <IconButton onClick={prevMonth} color={CCOO_GRAY} className="px-2 py-1 text-sm rounded-lg" disabled={new Date(year, month - 1) < new Date(today.getFullYear(), today.getMonth())}>&lt;</IconButton>
          <h4 className="text-lg font-semibold">{firstDayOfMonth.toLocaleString('es-ES', { month: 'long', year: 'numeric' })}</h4>
          <IconButton onClick={nextMonth} color={CCOO_GRAY} className="px-2 py-1 text-sm rounded-lg">&gt;</IconButton>
        </div>
        <div className="grid grid-cols-7 gap-1 text-sm font-medium text-center text-gray-500 mb-2">
          {['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'].map(d => <span key={d}>{d}</span>)}
        </div>
        <div className="grid grid-cols-7 gap-1">
          {Array(startDay).fill(null).map((_, i) => <div key={`empty-${i}`}></div>)}
          {days.map((date) => (
            <div
              key={date.toISOString()}
              className={getDayClass(date)}
              onClick={() => date.getDay() !== 0 && date.getDay() !== 6 && date >= today && handleDateChange(date)}
            >
              {date.getDate()}
            </div>
          ))}
        </div>
        {form.date && <p className="mt-4 text-sm text-gray-600">Fecha seleccionada: <strong>{selectedDay.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</strong></p>}
      </Card>
    );
  }, [form.date, selectedDay]); // Dependencia m√≠nima para evitar re-render innecesario de Citas

  const TimeSelector = useMemo(() => () => (
    <Card title="2. Selecciona Hora y Delegado" icon="‚è±Ô∏è" className="mt-6">
      <div className="flex flex-col space-y-3">
        {form.date ? (
          getAvailableSlots.length > 0 ? (
            getAvailableSlots.map(slot => (
              <label key={`${slot.time}-${slot.initials}`} className="flex items-center space-x-3 p-3 border rounded-xl shadow-sm hover:bg-red-50 cursor-pointer transition-colors">
                <input
                  type="radio"
                  name="time"
                  value={`${slot.time}-${slot.initials}`}
                  checked={form.time === `${slot.time}-${slot.initials}`}
                  onChange={handleInputChange}
                  className="form-radio h-5 w-5 text-red-600"
                />
                <span className="text-lg font-semibold">{slot.time}</span>
                <span className={`px-2 py-1 text-xs rounded-full font-medium ${slot.initials === 'JR' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'}`}>
                    {slot.rep}
                </span>
                <span className="text-xs text-gray-500 ml-auto">
                    {slot.initials === 'JR' ? 'Jos√© Ra√∫l' : 'Francisco'}
                </span>
              </label>
            ))
          ) : (
            <p className="text-gray-500">No hay horas disponibles para esta fecha.</p>
          )
        ) : (
          <p className="text-gray-500">Selecciona una fecha en el calendario.</p>
        )}
      </div>
    </Card>
  ), [form.date, form.time, getAvailableSlots, handleInputChange]);

  const FormularioCita = useMemo(() => () => (
    <Card title="3. Rellena tus Datos y Motivo" icon="üë§" className="mt-6">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700">Nombre Completo</label>
          <input type="text" name="name" value={form.name} onChange={handleInputChange} required className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border" />
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">DNI/NIE</label>
            <input type="text" name="dni" value={form.dni} onChange={handleInputChange} required pattern="[0-9]{8}[A-Z]" title="Debe ser 8 d√≠gitos seguidos de una letra (ej: 12345678A)" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border" />
          </div>
          <div>
            <label className="block text-sm font-medium text-gray-700">Tel√©fono (WhatsApp)</label>
            <input type="tel" name="phone" value={form.phone} onChange={handleInputChange} required className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border" />
          </div>
        </div>
        <div>
          <label className="block text-sm font-medium text-gray-700">Motivo de la Cita</label>
          <textarea name="matter" value={form.matter} onChange={handleInputChange} required rows="3" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border" />
        </div>
        <div className="flex items-center justify-between p-4 border rounded-xl bg-yellow-50">
          <label className="text-sm font-bold text-red-700 flex items-center">
            <span className="text-2xl mr-2">üö®</span>
            ¬øEs un caso urgente de acoso laboral o riesgo inminente?
          </label>
          <select name="urgency" value={form.urgency} onChange={handleInputChange} className="rounded-lg border-yellow-400 p-2 text-sm font-semibold text-red-700 bg-yellow-100">
            <option value="No">No</option>
            <option value="S√≠">S√≠ (Prioritario)</option>
          </select>
        </div>
        <IconButton type="submit" className="w-full" disabled={!form.date || !form.time || citasLoading}>
          {citasLoading ? 'Cargando Disponibilidad...' : 'Solicitar Cita y Enviar WhatsApp'}
        </IconButton>
        <p className="text-xs text-gray-500 mt-2">
            Al presionar, se abrir√° WhatsApp para enviar un mensaje de confirmaci√≥n a los delegados ({JR_PHONE.substring(2)} y {FA_PHONE.substring(2)}).
        </p>
      </form>
    </Card>
  ), [form.name, form.dni, form.phone, form.matter, form.urgency, form.date, form.time, handleInputChange, handleSubmit, citasLoading]);

  const CitasHistory = useMemo(() => () => (
    <Card title="Historial de Citas Solicitadas (Tus Citas)" icon="üóÑÔ∏è" className="mt-6">
      <div className="space-y-3 max-h-64 overflow-y-auto">
        {citasData.filter(c => c.creatorId === userId).length > 0 ? (
          citasData.filter(c => c.creatorId === userId).sort((a, b) => b.timestamp - a.timestamp).map(cita => (
            <div key={cita.id} className="p-3 border rounded-xl bg-gray-50">
              <p className="font-semibold text-gray-800">
                {cita.date} a las {cita.time} con {cita.union_rep === 'JR' ? 'Jos√© Ra√∫l' : 'Francisco'}
                <span className={`ml-2 text-xs font-bold px-2 py-0.5 rounded-full ${cita.urgency === 'S√≠' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>
                  {cita.urgency === 'S√≠' ? 'URGENTE' : 'Normal'}
                </span>
              </p>
              <p className="text-sm text-gray-600 truncate">Motivo: {cita.matter}</p>
              <p className="text-xs text-gray-400">Estado: {cita.status}</p>
            </div>
          ))
        ) : (
          <p className="text-gray-500">No has solicitado ninguna cita a√∫n.</p>
        )}
      </div>
    </Card>
  ), [citasData, userId]);


  return (
    <PageLayout title="Sistema de Citas Automatizado" logo={true} currentPage="Citas">
      <p className="text-lg mb-6">
        Selecciona una fecha y hora disponibles con Jos√© Ra√∫l Siles o Francisco Aguilera. Los casos de **Acoso Laboral** son de m√°xima prioridad y deben marcarse como urgentes.
      </p>
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <DayPicker />
          <TimeSelector />
          <CitasHistory />
        </div>
        <div>
          <FormularioCita />
        </div>
      </div>
    </PageLayout>
  );
};

// 3. CALCULADORA N√ìMINAS 2026 AVANZADA
const Nominas = () => {
  const [form, setForm] = useState({
    category: 'Vigilante Seguridad', antig√ºedad: 0, extra_hours: 0, nocturnity_hours: 0, irpf_percent: 15, prorrateo: 'No', festivos: 0, residencia_melilla: 'No',
  });
  // Antig√ºedad en quinquenios (5 a√±os)
  const quinquenios = useMemo(() => Math.floor(form.antig√ºedad / 5), [form.antig√ºedad]);

  // Handler de input reescrito y optimizado
  const handleInputChange = useCallback((e) => {
    const { name, value, type } = e.target;
    // CR√çTICO: Se utiliza Number() solo si el valor no est√° vac√≠o, sino se usa el valor original.
    // Esto previene que un campo vac√≠o sea NaN y rompa la calculadora.
    const finalValue = type === 'number' && value !== '' ? Number(value) : value;

    setForm(prev => ({ ...prev, [name]: finalValue }));
  }, [setForm]);


  const calculateNomina = useMemo(() => {
    const { category, extra_hours, nocturnity_hours, irpf_percent, prorrateo, festivos, residencia_melilla } = form;
    const baseData = SALARIOS_2026[category];
    if (!baseData) return null;

    // 1. Devengos Fijos
    const salario_base = baseData.base || 0;
    const plus_actividad = baseData.actividad || 0;
    // C√°lculo de antig√ºedad por quinquenios (5% por quinquenio, Art. 47 Convenio)
    const plus_antiguedad = quinquenios * 0.05 * salario_base; 
    const plus_residencia = residencia_melilla === 'S√≠' ? salario_base * 0.25 : 0; // 25% del salario base para Melilla

    let pagas_extras_prorrateadas = 0;
    const total_base = salario_base + plus_actividad + plus_antiguedad + plus_residencia;

    if (prorrateo === 'S√≠') {
      // 3 Pagas Extras: Salario Base + Plus Actividad + Antig√ºedad + Plus Residencia (si aplica)
      const extra_pay_amount = salario_base + plus_actividad + plus_antiguedad + plus_residencia; 
      pagas_extras_prorrateadas = (extra_pay_amount * 3) / 12;
    }

    const devengos_fijos = total_base + pagas_extras_prorrateadas;

    // 2. Devengos Variables
    const hours_per_year = 1766;
    const hour_value_ordinary = total_base * 12 / hours_per_year;
    const hour_value_extra = hour_value_ordinary * 1.75; // 75% incremento
    const actual_nocturnity_hours = nocturnity_hours || 0;
    const hour_value_nocturnity = nocturnity_hours > 0 ? (baseData.nocturnidad / 165) * 10 : 0; // Simulaci√≥n: 10‚Ç¨/h 
    const festivo_value = 40; // Simulaci√≥n: 40‚Ç¨ por festivo 

    const actual_extra_hours = extra_hours || 0;
    const actual_festivos = festivos || 0;
    const actual_irpf_percent = irpf_percent || 0;


    const devengos_variables = (actual_extra_hours * hour_value_extra) + (actual_nocturnity_hours * hour_value_nocturnity) + (actual_festivos * festivo_value);

    // 3. Devengo Total
    const total_devengos = devengos_fijos + devengos_variables;

    // 4. Deducciones
    // Base de cotizaci√≥n (simplificada)
    const base_cotizacion = total_base + pagas_extras_prorrateadas + devengos_variables; 
    const ss_deduction = base_cotizacion * 0.0635; // 6.35% SS (simplificado)

    // IRPF (porcentaje simplificado)
    const irpf_deduction = total_devengos * (actual_irpf_percent / 100);

    const total_deducciones = ss_deduction + irpf_deduction;

    // 5. Neto
    const neto = total_devengos - total_deducciones;

    // Resumen Anual (simulaci√≥n simple: 12x + 3 extras si no prorrateadas)
    const annual_base_for_extras = salario_base + plus_actividad + plus_antiguedad + plus_residencia;
    const annual_devengos_monthly = (annual_base_for_extras) * 12;
    const annual_extra_pays = prorrateo === 'No' ? (annual_base_for_extras) * 3 : 0;
    const annual_devengos = annual_devengos_monthly + annual_extra_pays + (devengos_variables * 12);
    const annual_ss = ss_deduction * 12;

    let annual_irpf_rate = 0;
    let taxable_income = annual_devengos - annual_ss; 
    
    // Simulaci√≥n de c√°lculo IRPF por tramos (muy simplificado)
    for (const tramo of IRPF_TABLE) {
      if (taxable_income <= tramo.limite) {
        annual_irpf_rate = tramo.tipo;
        break;
      }
    }
    const annual_irpf = annual_devengos * annual_irpf_rate;
    const annual_neto = annual_devengos - annual_ss - annual_irpf;


    return {
      salario_base,
      plus_actividad,
      plus_antiguedad,
      plus_residencia,
      pagas_extras_prorrateadas,
      hour_value_extra,
      devengos_fijos: devengos_fijos.toFixed(2),
      devengos_variables: devengos_variables.toFixed(2),
      total_devengos: total_devengos.toFixed(2),
      ss_deduction: ss_deduction.toFixed(2),
      irpf_deduction: irpf_deduction.toFixed(2),
      total_deducciones: total_deducciones.toFixed(2),
      neto: neto.toFixed(2),
      annual_neto: annual_neto.toFixed(2),
      annual_irpf_rate: (annual_irpf_rate * 100).toFixed(2),
    };

  }, [form, quinquenios]);

  const ResultRow = ({ label, value, isTotal = false }) => (
    <div className={`flex justify-between items-center py-2 ${isTotal ? 'border-t-4 border-double border-red-300' : 'border-b border-gray-100'} ${isTotal ? 'font-bold text-lg' : 'text-sm'}`}>
      <span className={isTotal ? 'text-red-700' : 'text-gray-600'}>{label}</span>
      <span className={isTotal ? 'text-red-700' : 'text-gray-800'}>{value} ‚Ç¨</span>
    </div>
  );

  const handleExportPDF = () => {
    // Implementaci√≥n de la funcionalidad de exportaci√≥n a PDF (simulaci√≥n con ventana de impresi√≥n)
    const data = calculateNomina;
    if (!data) return;

    const content = `
      <h1 style="color: ${CCOO_RED}; font-size: 24px; margin-bottom: 20px;">Desglose de N√≥mina CCOO Vigilantes (2026)</h1>
      <p><strong>Categor√≠a:</strong> ${form.category}</p>
      <p><strong>Antig√ºedad (Quinquenios):</strong> ${quinquenios}</p>
      <p><strong>Plus Residencia Melilla:</strong> ${form.residencia_melilla === 'S√≠' ? 'S√≠ (25% Salario Base)' : 'No'}</p>
      <p><strong>Pagas Extras:</strong> ${form.prorrateo === 'S√≠' ? 'Prorrateadas (3/a√±o)' : 'No Prorrateadas (Jun, Sep, Dic)'}</p>
      <hr style="margin: 20px 0; border-top: 1px solid #ccc;">

      <h2 style="font-size: 20px; color: ${CCOO_GRAY}; margin-bottom: 10px;">I. DEVENGOS MENSUALES</h2>
      <p>Salario Base: ${data.salario_base.toFixed(2)} ‚Ç¨</p>
      <p>Plus Actividad: ${data.plus_actividad.toFixed(2)} ‚Ç¨</p>
      <p>Plus Antig√ºedad: ${data.plus_antiguedad.toFixed(2)} ‚Ç¨</p>
      <p>Plus Residencia Melilla: ${data.plus_residencia.toFixed(2)} ‚Ç¨</p>
      <p>Pagas Extras Prorrateadas: ${data.pagas_extras_prorrateadas.toFixed(2)} ‚Ç¨</p>
      <p>TOTAL DEVENGOS FIJOS: ${data.devengos_fijos} ‚Ç¨</p>
      
      <h3 style="font-size: 18px; color: ${CCOO_GRAY}; margin-top: 15px; margin-bottom: 5px;">Devengos Variables</h3>
      <p>Horas Extra (75%): ${form.extra_hours || 0}h x ${data.hour_value_extra.toFixed(2)} ‚Ç¨/h</p>
      <p>Plus Nocturnidad (horas): ${form.nocturnity_hours || 0}h (Simulaci√≥n)</p>
      <p>Festivos Trabajados: ${form.festivos || 0} d√≠as (Simulaci√≥n)</p>
      <p>TOTAL DEVENGOS VARIABLES: ${data.devengos_variables} ‚Ç¨</p>
      
      <h4 style="font-size: 20px; color: ${CCOO_RED}; margin-top: 20px; font-weight: bold;">TOTAL DEVENGOS: ${data.total_devengos} ‚Ç¨</h4>
      
      <hr style="margin: 20px 0; border-top: 1px solid #ccc;">

      <h2 style="font-size: 20px; color: ${CCOO_GRAY}; margin-bottom: 10px;">II. DEDUCCIONES</h2>
      <p>Seguridad Social (6.35%): ${data.ss_deduction} ‚Ç¨</p>
      <p>IRPF (${form.irpf_percent || 0}% retenido): ${data.irpf_deduction} ‚Ç¨</p>
      <h4 style="font-size: 20px; color: ${CCOO_RED}; margin-top: 20px; font-weight: bold;">TOTAL NETO A PERCIBIR: ${data.neto} ‚Ç¨</h4>
      
      <hr style="margin: 20px 0; border-top: 1px solid #ccc;">
      
      <h2 style="font-size: 20px; color: ${CCOO_GRAY}; margin-bottom: 10px;">III. RESUMEN ANUAL (Simulado)</h2>
      <p>Renta Anual Estimada: ${data.annual_neto} ‚Ç¨ (Base Imponible para IRPF: Tasa ${data.annual_irpf_rate}%)</p>
      <p style="font-size: 12px; margin-top: 10px;">Generado por Plataforma CCOO Vigilantes.</p>
    `;

    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>N√≥mina CCOO Vigilantes</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif; padding: 30px;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(content);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
  };

  const categories = Object.keys(SALARIOS_2026);

  // Componente Nominas memoizado
  const NominasContent = useMemo(() => (
    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Columna de Input */}
        <Card title="Datos de C√°lculo" icon="‚öôÔ∏è" className="lg:col-span-1">
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700">Categor√≠a Profesional</label>
              <select name="category" value={form.category} onChange={handleInputChange} className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border">
                {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
              </select>
            </div>
            {/* OPCI√ìN: PLUS DE RESIDENCIA MELILLA */}
            <div className="flex justify-between items-center p-2 border rounded-lg bg-blue-50">
                <label className="text-sm font-bold text-blue-700">Plus de Residencia (Melilla - 25% SB)</label>
                <select name="residencia_melilla" value={form.residencia_melilla} onChange={handleInputChange} className="rounded-lg border-blue-300 p-1 text-sm font-semibold text-blue-700 bg-blue-100">
                    <option value="No">No</option>
                    <option value="S√≠">S√≠</option>
                </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700">A√±os de Antig√ºedad en la Empresa (Quinquenios: {quinquenios})</label>
              <input type="number" name="antig√ºedad" value={form.antig√ºedad} onChange={handleInputChange} min="0" max="50" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Horas Extra Trabajadas (Mes) (+75%)</label>
              <input type="number" name="extra_hours" value={form.extra_hours} onChange={handleInputChange} min="0" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Horas Nocturnas Trabajadas (Simulaci√≥n)</label>
              <input type="number" name="nocturnity_hours" value={form.nocturnity_hours} onChange={handleInputChange} min="0" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">D√≠as Festivos Trabajados (Simulaci√≥n)</label>
              <input type="number" name="festivos" value={form.festivos} onChange={handleInputChange} min="0" max="14" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
            </div>
            <div className="flex justify-between items-center p-2 border rounded-lg">
              <label className="text-sm font-medium text-gray-700">Pagas Extras Prorrateadas (3/a√±o)</label>
              <select name="prorrateo" value={form.prorrateo} onChange={handleInputChange} className="rounded-lg border-gray-300 p-1 text-sm">
                <option value="No">No</option>
                <option value="S√≠">S√≠</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Retenci√≥n IRPF (%) (Estimada)</label>
              <input type="number" name="irpf_percent" value={form.irpf_percent} onChange={handleInputChange} min="0" max="50" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
            </div>
          </div>
        </Card>

        {/* Columna de Resultados Mensuales */}
        <Card title="Desglose Mensual (Estimado)" icon="üìä" className="lg:col-span-2">
          {calculateNomina ? (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h3 className="font-bold mb-2 text-ccoored">I. DEVENGOS</h3>
                <ResultRow label="Salario Base" value={calculateNomina.salario_base.toFixed(2)} />
                <ResultRow label="Plus Actividad" value={calculateNomina.plus_actividad.toFixed(2)} />
                <ResultRow label="Plus Antig√ºedad (Quinquenio)" value={calculateNomina.plus_antiguedad.toFixed(2)} />
                <ResultRow label="Plus Residencia (Melilla)" value={calculateNomina.plus_residencia.toFixed(2)} />
                <ResultRow label="Pagas Extras Prorrateadas (3/12)" value={calculateNomina.pagas_extras_prorrateadas.toFixed(2)} />
                <ResultRow label="Horas Extra (75%)" value={(calculateNomina.hour_value_extra * (form.extra_hours || 0)).toFixed(2)} />
                <ResultRow label="Plus Nocturnidad (Sim.)" value={(calculateNomina.total_devengos - calculateNomina.devengos_fijos - (calculateNomina.hour_value_extra * (form.extra_hours || 0)) - ((form.festivos || 0) * 40)).toFixed(2)} />
                <ResultRow label="Plus Festivo (Sim.)" value={((form.festivos || 0) * 40).toFixed(2)} />
                <ResultRow label="TOTAL DEVENGOS" value={calculateNomina.total_devengos} isTotal={true} />
              </div>
              
              <div>
                <h3 className="font-bold mb-2 text-ccoored">II. DEDUCCIONES</h3>
                <ResultRow label={`Seguridad Social (6.35%)`} value={calculateNomina.ss_deduction} />
                <ResultRow label={`IRPF Retenido (${form.irpf_percent || 0}%)`} value={calculateNomina.irpf_deduction} />
                <ResultRow label="TOTAL DEDUCCIONES" value={calculateNomina.total_deducciones} isTotal={true} />

                <h3 className="font-bold mt-6 mb-2 text-ccoored">III. RESUMEN</h3>
                <ResultRow label="SALARIO NETO ESTIMADO" value={calculateNomina.neto} isTotal={true} />
                
                <h3 className="font-bold mt-6 mb-2 text-ccoored">IV. DATOS ANUALES (Estimado)</h3>
                <ResultRow label="IRPF Anual Estimado (%)" value={calculateNomina.annual_irpf_rate} />
                <ResultRow label="NETO ANUAL PROYECTADO" value={calculateNomina.annual_neto} isTotal={true} />

                <div className="mt-6 space-y-3">
                    <IconButton onClick={handleExportPDF} color={CCOO_GRAY} className="w-full">
                      Exportar Desglose a PDF
                    </IconButton>
                    <div className="p-3 bg-red-50 border border-red-200 rounded-xl">
                        <p className="text-sm font-semibold text-red-700">Simulador de Subidas:</p>
                        <p className="text-xs text-red-600">El valor base ya incluye el incremento del 3% para 2026. Para simular subidas futuras, puedes ajustar manualmente el Salario Base en un simulador externo.</p>
                    </div>
                </div>
              </div>
            </div>
          ) : (
            <p>Selecciona una categor√≠a para comenzar el c√°lculo.</p>
          )}
        </Card>
      </div>
  ), [form, quinquenios, calculateNomina, handleInputChange]);

  return (
    <PageLayout title="Calculadora de N√≥minas 2026 Avanzada" logo={true} currentPage="Nominas">
      <p className="text-lg mb-6">
        Simula tu n√≥mina mensual y anual con los datos del Convenio 2023-2026 (Salarios 2026 aplicados). La antig√ºedad se calcula por **quinquenios** (5% cada 5 a√±os).
      </p>
      <NominasContent />
    </PageLayout>
  );
};

// 4. GENERADOR ESCRITOS LEGALES
const Escritos = () => {
    const ESCRITOS_MODELS = [
        { 
            id: 'reclamacion_nomina', 
            title: 'Reclamaci√≥n de Cantidades (N√≥mina)', 
            legal: 'Art. 29 ET, Art. 40-47 Convenio',
            fields: ['nombre_empresa', 'importe', 'concepto'],
            content: (f, u) => `
                ASUNTO: Reclamaci√≥n de Cantidades.
                
                Por la presente, yo, ${u.NOMBRE_TRABAJADOR} con DNI ${u.DNI_TRABAJADOR}, y fecha de alta ${u.FECHA_ALTA}, me dirijo a la empresa ${f.nombre_empresa} para reclamar formalmente la cantidad de ${f.importe || '[IMPORTE]'} euros correspondientes al concepto ${f.concepto || '[CONCEPTO]'} y devengados en el mes de [MES].

                Dicha reclamaci√≥n se fundamenta en el incumplimiento del Art. 29 del Estatuto de los Trabajadores y los Art√≠culos 40 a 47 del Convenio Colectivo, que regulan la puntualidad y cuant√≠a del salario.

                Se requiere el abono inmediato de la cantidad adeudada. En caso contrario, se interpondr√° la correspondiente papeleta de conciliaci√≥n y posterior demanda judicial.
                
                En ${u.CIUDAD}, a ${u.FECHA_ACTUAL}.
            `
        },
        { 
            id: 'denuncia_acoso', 
            title: 'üö® Denuncia Acoso Laboral', 
            legal: 'Art. 8 bis LO 3/2007, Art. 173 CP',
            fields: ['acoso_tipo', 'nombre_acosador', 'descripcion_hechos'],
            is_urgent: true,
            content: (f, u) => `
                ASUNTO: Denuncia Formal de Acoso Laboral (Mobbing) y Solicitud de Aplicaci√≥n de Protocolo.
                
                Yo, ${u.NOMBRE_TRABAJADOR} con DNI ${u.DNI_TRABAJADOR}, denuncio formalmente estar sufriendo acoso laboral (tipo: ${f.acoso_tipo || '[TIPO DE ACOSO]'}) por parte de ${f.nombre_acosador || '[NOMBRE DEL ACOSDOR]'} (cargo: [CARGO_ACOSADOR]).

                Los hechos consisten en: ${f.descripcion_hechos || '[DESCRIBIR HECHOS Y FECHAS, APORTAR PRUEBAS]'}.

                Esta conducta vulnera mi dignidad, integridad moral y la normativa vigente (Art. 8 bis LO 3/2007, Art. 173 CP).

                Solicito la aplicaci√≥n inmediata del Protocolo de Acoso Laboral y la adopci√≥n de medidas cautelares (ej: cambio de turno/centro de trabajo).

                En ${u.CIUDAD}, a ${u.FECHA_ACTUAL}.
            `
        },
        { 
            id: 'solicitud_vacaciones', 
            title: 'Solicitud de Vacaciones', 
            legal: 'Art. 38 ET, Art. 57 Convenio',
            fields: ['fecha_inicio', 'fecha_fin', 'dias_solicitados'],
            content: (f, u) => `
                ASUNTO: Solicitud de Disfrute de Vacaciones Anuales.
                
                Yo, ${u.NOMBRE_TRABAJADOR} con DNI ${u.DNI_TRABAJADOR}, solicito formalmente el disfrute de ${f.dias_solicitados || '[DIAS]'} d√≠as naturales de vacaciones, a partir del ${f.fecha_inicio || '[FECHA INICIO]'} y hasta el ${f.fecha_fin || '[FECHA FIN]'}.

                Esta solicitud se realiza con la antelaci√≥n m√≠nima de dos meses establecida en el Art. 38 del Estatuto de los Trabajadores y el Art. 57 del Convenio Colectivo. 

                Ruego su confirmaci√≥n por escrito.
                
                En ${u.CIUDAD}, a ${u.FECHA_ACTUAL}.
            `
        },
        { 
            id: 'recurso_sancion', 
            title: 'Recurso Sanci√≥n Disciplinaria', 
            legal: 'Art. 58 ET, Art. 71-76 Convenio',
            fields: ['sancion_fecha', 'sancion_motivo', 'alegaciones'],
            content: (f, u) => `
                ASUNTO: Recurso y Alegaciones contra Sanci√≥n de [TIPO DE SANCI√ìN] de fecha ${f.sancion_fecha || '[FECHA SANCI√ìN]'}.

                Yo, ${u.NOMBRE_TRABAJADOR} con DNI ${u.DNI_TRABAJADOR}, en tiempo y forma, presento Recurso de Reposici√≥n contra la sanci√≥n notificada el ${f.sancion_fecha || '[FECHA SANCI√ìN]'} por el motivo ${f.sancion_motivo || '[MOTIVO]'}.

                ALEGACIONES: Los hechos no son ciertos / la sanci√≥n es desproporcionada, por lo siguiente: ${f.alegaciones || '[ARGUMENTAR DEFENSAS]'}.

                Se solicita la anulaci√≥n de la sanci√≥n de acuerdo con los Art√≠culos 71 a 76 del Convenio y el Art. 58 del ET.
                
                En ${u.CIUDAD}, a ${u.FECHA_ACTUAL}.
            `
        },
        { 
            id: 'reclamacion_prl_equipos', 
            title: 'Reclamaci√≥n Equipos de PRL', 
            legal: 'Ley 31/1995, RD 773/1997',
            fields: ['equipo_faltante', 'puesto'],
            content: (f, u) => `
                ASUNTO: Denuncia de Riesgo y Reclamaci√≥n de Equipos de Protecci√≥n Individual (EPI).

                Yo, ${u.NOMBRE_TRABAJADOR} con DNI ${u.DNI_TRABAJADOR}, en mi puesto de ${f.puesto || '[PUESTO]'}, denuncio la falta de suministro del equipo de protecci√≥n individual (EPI) obligatorio: ${f.equipo_faltante || '[EQUIPO FALTANTE]'}.

                Esta situaci√≥n incumple la Ley 31/1995 de PRL y el RD 773/1997 sobre disposiciones m√≠nimas de seguridad.

                Se requiere el suministro inmediato del equipo, de lo contrario se proceder√° a solicitar a los Delegados de Prevenci√≥n la paralizaci√≥n de la actividad.
                
                En ${u.CIUDAD}, a ${u.FECHA_ACTUAL}.
            `
        },
        // M√°s modelos para alcanzar el m√≠nimo de 15:
        { id: 'solicitud_cambio_turno', title: 'Solicitud Cambio de Turno/Jornada', legal: 'Art. 34.8 ET, Art. 52 Convenio', fields: ['turno_actual', 'turno_solicitado', 'justificacion'], content: (f, u) => `ASUNTO: Solicitud de Adaptaci√≥n de Jornada / Cambio de Turno. Yo, ${u.NOMBRE_TRABAJADOR}, actualmente presto servicio en ${f.turno_actual || '[TURNO ACTUAL]'}. Solicito cambio a ${f.turno_solicitado || '[TURNO SOLICITADO]'} por motivos de conciliaci√≥n / personales, justificando en: ${f.justificacion || '[JUSTIFICACI√ìN]'} (Art. 34.8 ET / Art. 52 Convenio)` },
        { id: 'comunicacion_baja_it', title: 'Comunicaci√≥n de Baja IT', legal: 'Art. 45 ET, LGSS', fields: ['it_fecha', 'it_motivo'], content: (f, u) => `ASUNTO: Comunicaci√≥n de Baja por Incapacidad Temporal. Yo, ${u.NOMBRE_TRABAJADOR}, comunico mi situaci√≥n de baja m√©dica por Incapacidad Temporal (IT) con fecha ${f.it_fecha || '[FECHA BAJA]'}, debido a ${f.it_motivo || '[MOTIVO]'}. Adjunto el correspondiente parte de baja. (Art. 45.1.c) ET)` },
        { id: 'solicitud_permiso_retribuido', title: 'Solicitud Permiso Retribuido (Hospitalizaci√≥n/Fallecimiento)', legal: 'Art. 37 ET, Art. 56 Convenio', fields: ['permiso_motivo', 'fecha_inicio_dias', 'parentesco'], content: (f, u) => `ASUNTO: Solicitud de Permiso Retribuido de 5 d√≠as. Yo, ${u.NOMBRE_TRABAJADOR}, solicito 5 d√≠as de permiso retribuido a partir del ${f.fecha_inicio_dias || '[FECHA INICIO]'}, por motivo de ${f.permiso_motivo || '[MOTIVO]'} de mi familiar ${f.parentesco || '[PARENTESCO]'}. (Art. 37.3.b) ET / Art. 56 Convenio)` },
        { id: 'reclamacion_subrogacion', title: 'Reclamaci√≥n Subrogaci√≥n', legal: 'Art. 44 ET, Art. 78-79 Convenio', fields: ['empresa_saliente', 'empresa_entrante', 'motivo'], content: (f, u) => `ASUNTO: Reclamaci√≥n de Inclusi√≥n en Subrogaci√≥n de Empresa. Yo, ${u.NOMBRE_TRABAJADOR}, me dirijo a las empresas ${f.empresa_saliente || '[SALIENTE]'} y ${f.empresa_entrante || '[ENTRANTE]'}. Exijo ser incluido en el proceso de subrogaci√≥n por cumplir con los requisitos del Art. 78-79 del Convenio. Mi situaci√≥n es: ${f.motivo || '[MOTIVO/ANTIG√úEDAD]'}` },
        { id: 'solicitud_excedencia', title: 'Solicitud de Excedencia Voluntaria', legal: 'Art. 46 ET', fields: ['excedencia_tipo', 'fecha_inicio', 'duracion'], content: (f, u) => `ASUNTO: Solicitud de Excedencia ${f.excedencia_tipo || '[TIPO]'}. Yo, ${u.NOMBRE_TRABAJADOR}, solicito un per√≠odo de excedencia de ${f.duracion || '[DURACI√ìN]'} a√±os/meses a partir de ${f.fecha_inicio || '[FECHA INICIO]'}. (Art. 46 ET)` },
        { id: 'denuncia_modificacion_condiciones', title: 'Denuncia Modificaci√≥n Sustancial de Condiciones', legal: 'Art. 41 ET', fields: ['modificacion_tipo', 'modificacion_descripcion'], content: (f, u) => `ASUNTO: Impugnaci√≥n de Modificaci√≥n Sustancial de Condiciones. Yo, ${u.NOMBRE_TRABAJADOR}, me opongo a la modificaci√≥n de ${f.modificacion_tipo || '[TIPO DE CONDICI√ìN]'} (ej: horario, salario) notificada el [FECHA_NOTIFICACION]. La modificaci√≥n consiste en: ${f.modificacion_descripcion || '[DESCRIPCI√ìN]'}. (Art. 41 ET)` },
        { id: 'impugnacion_despido', title: 'Impugnaci√≥n de Despido (Papeleta de Conciliaci√≥n)', legal: 'Art. 59.3 ET', fields: ['despido_fecha', 'despido_motivo'], content: (f, u) => `ASUNTO: Impugnaci√≥n de Despido / Papeleta de Conciliaci√≥n. Yo, ${u.NOMBRE_TRABAJADOR}, fui despedido/a el ${f.despido_fecha || '[FECHA DESPIDO]'} por el motivo ${f.despido_motivo || '[MOTIVO]'}. Considero el despido improcedente/nulo. Solicito la readmisi√≥n o la m√°xima indemnizaci√≥n legal. (Art. 59.3 ET - Plazo de 20 d√≠as h√°biles)` },
        { id: 'solicitud_reduccion_jornada', title: 'Solicitud Reducci√≥n Jornada (Guarda Legal)', legal: 'Art. 37.6 ET', fields: ['porcentaje_reduccion', 'motivo_guarda'], content: (f, u) => `ASUNTO: Solicitud Reducci√≥n de Jornada por Guarda Legal. Yo, ${u.NOMBRE_TRABAJADOR}, solicito reducci√≥n de mi jornada en ${f.porcentaje_reduccion || '[PORCENTAJE]'}% (m√≠nimo 1/8, m√°ximo 1/2) a partir de [FECHA_INICIO], por ${f.motivo_guarda || '[MOTIVO GUARDA LEGAL]'} (menor de 12 a√±os/familiar). (Art. 37.6 ET)` },
        { id: 'reclamacion_formacion_tip', title: 'Reclamaci√≥n Formaci√≥n TIP/Reciclaje', legal: 'Art. 19 ET, Art. 21 Convenio', fields: ['formacion_faltante', 'fecha_vencimiento_tip'], content: (f, u) => `ASUNTO: Reclamaci√≥n de Formaci√≥n Continua Obligatoria. Yo, ${u.NOMBRE_TRABAJADOR}, reclamo el curso de formaci√≥n obligatoria (${f.formacion_faltante || '[CURSO FALTANTE]'}). Mi TIP vence el ${f.fecha_vencimiento_tip || '[FECHA VENCIMIENTO]'}. La formaci√≥n es coste y tiempo efectivo de la empresa. (Art. 19 ET)` },
        { id: 'denuncia_incumplimiento_prl', title: 'Denuncia Incumplimiento General PRL', legal: 'Art. 21 LPRL', fields: ['riesgo_descripcion', 'ubicacion_riesgo'], content: (f, u) => `ASUNTO: Denuncia Incumplimiento de Medidas de PRL. Yo, ${u.NOMBRE_TRABAJADOR}, denuncio la siguiente situaci√≥n de riesgo: ${f.riesgo_descripcion || '[DESCRIPCI√ìN RIESGO]'}, en la ubicaci√≥n ${f.ubicacion_riesgo || '[UBICACI√ìN]'}. Solicito actuaci√≥n inmediata para corregir el riesgo, de lo contrario se activar√° el Art. 21 LPRL. (Art. 21 LPRL)` },
    ];
    
    const [selectedEscrito, setSelectedEscrito] = useState(ESCRITOS_MODELS[0]);
    const [formData, setFormData] = useState({});
    const [generatedText, setGeneratedText] = useState('');
    const [modalOpen, setModalOpen] = useState(false);
    const [userInfo, setUserInfo] = useState({ 
        'NOMBRE_TRABAJADOR': 'Vigilante de Prueba', 
        'DNI_TRABAJADOR': '12345678A',
        'FECHA_ALTA': '01/01/2020',
        'CIUDAD': 'Melilla', // Usar Melilla por defecto ya que es tu ubicaci√≥n
        'FECHA_ACTUAL': new Date().toLocaleDateString('es-ES'),
        'CARGO_ACOSADOR': 'Jefe de Equipo / Responsable',
        'TIPO DE SANCI√ìN': 'Amonestaci√≥n/Suspensi√≥n de Empleo',
    });
    
    useEffect(() => {
        // Inicializar formData al cambiar el escrito seleccionado
        const initialForm = {};
        selectedEscrito.fields.forEach(field => {
            initialForm[field] = '';
        });
        setFormData(initialForm);
        setGeneratedText('');
    }, [selectedEscrito]);
    
    // Handler de input optimizado para escritos (CR√çTICO para estabilidad)
    const handleFieldChange = useCallback((e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    }, [setFormData]);

    const handleGenerate = () => {
        // Generar texto usando el contenido del modelo y los datos del formulario/usuario
        const content = selectedEscrito.content(formData, userInfo);
        
        setGeneratedText(content.trim());
        setModalOpen(true);
    };

    const handleCopy = () => {
        if (generatedText) {
            // Usa execCommand('copy') por ser m√°s compatible en entornos de iframe
            const el = document.createElement('textarea');
            el.value = generatedText;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            alert("Texto copiado al portapapeles.");
        }
    };

    const handleDownloadPDF = () => {
        // Simulaci√≥n de descarga (imprime el contenido formateado)
        const content = generatedText.replace(/\n/g, '<br>');
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Escrito Legal CCOO</title>');
        printWindow.document.write(`<style>
            body { font-family: 'Inter', sans-serif; padding: 30px; line-height: 1.6; }
            h1 { color: ${CCOO_RED}; font-size: 24px; margin-bottom: 20px; border-bottom: 2px solid ${CCOO_RED}; padding-bottom: 10px; }
            .urgent { color: red; font-weight: bold; }
        </style>`);
        printWindow.document.write('</head><body>');
        printWindow.document.write(`<h1>${selectedEscrito.title}</h1>`);
        printWindow.document.write(`<p><strong>Fundamento Legal:</strong> ${selectedEscrito.legal}</p><br>`);
        printWindow.document.write(content);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        printWindow.print();
    };

    const UrgentAlert = ({ title }) => (
        <div className="bg-red-500 text-white p-4 rounded-xl shadow-lg font-bold flex items-center mb-6">
            <span className="text-3xl mr-3">üö®</span>
            ¬°ATENCI√ìN! ESTE ESCRITO ES PARA CASOS URGENTES DE {title.toUpperCase()}. CONTACTA TAMBI√âN INMEDIATAMENTE CON CCOO.
        </div>
    );

    const EscritosContent = useMemo(() => (
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Columna de Selecci√≥n */}
            <Card title="Modelos Disponibles (15+)" icon="üìö" className="lg:col-span-1">
                <ul className="space-y-2 max-h-96 overflow-y-auto">
                    {ESCRITOS_MODELS.map(escrito => (
                        <li 
                            key={escrito.id} 
                            onClick={() => setSelectedEscrito(escrito)}
                            className={`p-3 rounded-xl cursor-pointer transition-colors border shadow-sm ${selectedEscrito.id === escrito.id ? 'bg-red-100 border-red-500 font-bold text-red-800' : 'hover:bg-gray-50'}`}
                        >
                            <span className="text-xs font-semibold block">{escrito.legal}</span>
                            {escrito.title}
                        </li>
                    ))}
                </ul>
            </Card>

            {/* Columna de Formulario */}
            <Card title={`Rellenar: ${selectedEscrito.title}`} icon="‚úçÔ∏è" className="lg:col-span-2">
                <p className="text-sm text-gray-600 mb-4">
                    Fundamento: <strong>{selectedEscrito.legal}</strong>
                </p>
                <div className="space-y-4">
                    {selectedEscrito.fields.map(field => (
                        <div key={field}>
                            <label className="block text-sm font-medium text-gray-700 capitalize">
                                {field.replace(/_/g, ' ').replace('acoso tipo', 'Tipo de Acoso').replace('fecha inicio dias', 'Fecha Inicio')}
                            </label>
                            <input 
                                type={field.includes('fecha') ? 'date' : field.includes('importe') ? 'number' : 'text'} 
                                name={field} 
                                value={formData[field] || ''} 
                                onChange={handleFieldChange} 
                                required 
                                placeholder={`Introduce ${field.replace(/_/g, ' ')}...`}
                                className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 p-2 border" 
                            />
                        </div>
                    ))}
                </div>
                {/* Bot√≥n generar est√° fuera del useMemo para garantizar su estabilidad con el estado principal */}
            </Card>
        </div>
    ), [selectedEscrito, formData, handleFieldChange]);

    return (
        <PageLayout title="Generador de Escritos Legales" logo={true} currentPage="Escritos">
            <p className="text-lg mb-6">
                Selecciona uno de los 15+ modelos de escritos legales. Rellena los campos obligatorios y genera un documento listo para copiar, descargar en PDF e imprimir, con la base legal correcta.
            </p>

            {selectedEscrito.is_urgent && <UrgentAlert title={selectedEscrito.title.replace('üö® Denuncia ', '').toUpperCase()} />}

            <EscritosContent />
            
            {/* Bot√≥n generar fuera del memo para asegurar que siempre use la funci√≥n estable handleGenerate */}
            <IconButton onClick={handleGenerate} className="w-full mt-6">
                Generar Escrito
            </IconButton>

            {/* Modal de Resultado */}
            <Modal title={selectedEscrito.title} open={modalOpen} onClose={() => setModalOpen(false)}>
                <p className="text-sm font-bold text-gray-700 mb-4">
                    Fundamento Legal: <span className="text-ccoored">{selectedEscrito.legal}</span>
                </p>
                <textarea 
                    value={generatedText} 
                    readOnly 
                    rows="15" 
                    className="w-full p-4 border rounded-xl bg-gray-50 font-mono text-sm resize-none"
                />
                <div className="flex space-x-4 mt-4">
                    <IconButton onClick={handleCopy} className="flex-1 bg-green-600">
                        Copiar Texto
                    </IconButton>
                    <IconButton onClick={handleDownloadPDF} className="flex-1 bg-blue-600">
                        Descargar/Imprimir PDF
                    </IconButton>
                </div>
            </Modal>
        </PageLayout>
    );
};

// 5. FAQ INTELIGENTE
const FAQ = () => {
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('Todas');
    const [favorites, setFavorites] = useState(JSON.parse(localStorage.getItem('faq_favorites')) || []);
    const [history, setHistory] = useState(JSON.parse(localStorage.getItem('faq_history')) || []);
    const [activeQuestion, setActiveQuestion] = useState(null);

    const handleSearch = useCallback((e) => setSearchTerm(e.target.value), []);
    const handleCategoryChange = useCallback((cat) => {
        setSelectedCategory(cat);
        setSearchTerm(''); // Limpiar b√∫squeda al cambiar de categor√≠a
    }, []);

    const filteredFAQ = useMemo(() => {
        let results = FULL_FAQ_DATA;

        if (selectedCategory !== 'Todas') {
            results = results.filter(item => item.cat === selectedCategory);
        }

        if (searchTerm) {
            results = results.filter(item => 
                item.q.toLowerCase().includes(searchTerm.toLowerCase()) || 
                item.a.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }
        
        return results.slice(0, 50); // Limitar a 50 resultados para performance
    }, [searchTerm, selectedCategory]);
    
    // Funci√≥n para manejar la apertura/cierre y el historial
    const handleToggleQuestion = useCallback((item) => {
        if (activeQuestion === item.id) {
            setActiveQuestion(null);
        } else {
            setActiveQuestion(item.id);
            // A√±adir al historial
            const newHistory = [{ ...item, viewedAt: Date.now() }, ...history.filter(h => h.id !== item.id)].slice(0, 10);
            setHistory(newHistory);
            localStorage.setItem('faq_history', JSON.stringify(newHistory));
        }
    }, [activeQuestion, history]);

    const handleToggleFavorite = useCallback((item) => {
        const isFav = favorites.some(fav => fav.id === item.id);
        let newFavorites;

        if (isFav) {
            newFavorites = favorites.filter(fav => fav.id !== item.id);
        } else {
            newFavorites = [...favorites, item];
        }

        setFavorites(newFavorites);
        localStorage.setItem('faq_favorites', JSON.stringify(newFavorites));
    }, [favorites]);

    const handleRateAnswer = (item, isUseful) => {
        // L√≥gica de valoraci√≥n (solo simulaci√≥n visual o almacenamiento de m√©tricas)
        alert(`Gracias por tu valoraci√≥n. Marcaste la respuesta como ${isUseful ? '√ötil' : 'No √ötil'}.`);
    };

    const isFavorite = (id) => favorites.some(fav => fav.id === id);
    
    const CategorySelector = useMemo(() => () => (
        <div className="flex flex-wrap gap-2 mb-6">
            {['Todas', ...FAQ_CATEGORIES].map(cat => (
                <button
                    key={cat}
                    onClick={() => handleCategoryChange(cat)}
                    className={`px-4 py-2 rounded-full text-sm font-semibold shadow-md transition-colors ${selectedCategory === cat ? 'bg-red-700 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                >
                    {cat} ({cat === 'Todas' ? FULL_FAQ_DATA.length : FULL_FAQ_DATA.filter(i => i.cat === cat).length})
                </button>
            ))}
        </div>
    ), [selectedCategory, handleCategoryChange]);
    
    const QuestionItem = ({ item }) => (
        <div className="border-b border-gray-200 py-3">
            <button 
                onClick={() => handleToggleQuestion(item)} 
                className="w-full flex justify-between items-center text-left text-lg font-semibold hover:text-red-700 transition-colors"
                style={{ color: isFavorite(item.id) ? CCOO_RED : CCOO_GRAY }}
            >
                {item.q}
                <span className="text-xl">
                    {activeQuestion === item.id ? '‚ûñ' : '‚ûï'}
                </span>
            </button>
            {activeQuestion === item.id && (
                <div className="mt-2 p-4 bg-red-50 rounded-xl shadow-inner text-gray-700 text-sm">
                    <p className="whitespace-pre-wrap">{item.a}</p>
                    <div className="flex justify-between items-center mt-4 pt-3 border-t border-red-200 text-xs">
                        <div className="space-x-2">
                            <button onClick={() => handleToggleFavorite(item)} className="text-gray-600 hover:text-yellow-600">
                                {isFavorite(item.id) ? '‚≠ê Quitar Favorito' : '‚≠ê A√±adir a Favoritos'}
                            </button>
                            <button onClick={() => handleRateAnswer(item, true)} className="text-green-600 hover:font-bold">üëç √ötil</button>
                            <button onClick={() => handleRateAnswer(item, false)} className="text-red-600 hover:font-bold">üëé No √ötil</button>
                        </div>
                        <span className="text-gray-500">Categor√≠a: {item.cat}</span>
                    </div>
                </div>
            )}
        </div>
    );

    const HistoryPanel = useMemo(() => () => (
        <Card title="Historial y Favoritos" icon="üåü" className="h-full">
            <h4 className="font-bold mb-2 text-ccoored">Favoritos ({favorites.length})</h4>
            <ul className="space-y-1 text-sm mb-4 max-h-40 overflow-y-auto">
                {favorites.map(item => (
                    <li key={item.id} className="text-gray-600 hover:text-red-700 cursor-pointer truncate" onClick={() => handleToggleQuestion(item)}>
                        ‚≠ê {item.q}
                    </li>
                ))}
                {favorites.length === 0 && <li className="text-gray-500">Ning√∫n favorito guardado.</li>}
            </ul>

            <h4 className="font-bold mb-2 text-ccoored">√öltimas Consultas ({history.length})</h4>
            <ul className="space-y-1 text-sm max-h-40 overflow-y-auto">
                {history.map(item => (
                    <li key={item.id} className="text-gray-600 hover:text-red-700 cursor-pointer truncate" onClick={() => handleToggleQuestion(item)}>
                        <span className="text-xs text-gray-400 mr-1">[{new Date(item.viewedAt).toLocaleTimeString()}]</span> {item.q}
                    </li>
                ))}
                {history.length === 0 && <li className="text-gray-500">Ninguna consulta reciente.</li>}
            </ul>
            
            <h4 className="font-bold mt-4 mb-2 text-ccoored">Sugerir Nueva Pregunta</h4>
            <textarea 
                placeholder="Escribe tu pregunta o duda para que CCOO la revise y a√±ada al FAQ..."
                rows="3"
                className="w-full p-2 border rounded-lg resize-none text-sm"
            />
            <IconButton className="w-full mt-2 bg-gray-500 text-white hover:bg-gray-600">
                Enviar Sugerencia
            </IconButton>
        </Card>
    ), [favorites, history, handleToggleQuestion]);


    return (
        <PageLayout title="FAQ Inteligente y Asesor√≠a R√°pida (200+ Preguntas)" logo={true} currentPage="FAQ">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* Columna de Filtro y Preguntas */}
                <div className="lg:col-span-2">
                    <Card title="B√∫squeda y Categor√≠as" icon="üîé">
                        <input
                            type="text"
                            placeholder="Buscar en 200+ preguntas (ej: 'horas extra' o 'subrogaci√≥n')..."
                            value={searchTerm}
                            onChange={handleSearch}
                            className="w-full p-3 mb-4 rounded-xl border-2 border-gray-300 focus:border-red-500 focus:ring-red-500 shadow-inner"
                        />
                        <CategorySelector />
                    </Card>
                    
                    <Card title={`Resultados (${filteredFAQ.length})`} icon="üí¨" className="mt-6 max-h-[60vh] overflow-y-auto">
                        {filteredFAQ.length > 0 ? (
                            filteredFAQ.map(item => <QuestionItem key={item.id} item={item} />)
                        ) : (
                            <p className="text-gray-500">No se encontraron resultados para tu b√∫squeda.</p>
                        )}
                    </Card>
                </div>

                {/* Columna de Historial/Favoritos */}
                <div className="lg:col-span-1">
                    <HistoryPanel />
                </div>
            </div>
        </PageLayout>
    );
};

// 6. PREVENCI√ìN RIESGOS LABORALES COMPLETO (PRL)
const PRL = () => {
    const [riskForm, setRiskForm] = useState({
        location: '', risk: '', description: '', name: '', phone: '', is_anonymous: false
    });
    const [modalOpen, setModalOpen] = useState(false);

    const PROTOCOL_STEPS = [
        { title: "Identificaci√≥n y Aislamiento", desc: "La v√≠ctima debe identificar la conducta y documentarla (fechas, horas, testigos). Buscar apoyo de CCOO. No confrontar al acosador sin respaldo." },
        { title: "Comunicaci√≥n a Delegados", desc: "Informar de inmediato a los Delegados de Prevenci√≥n y al Comit√© de Empresa. Ellos est√°n obligados a guardar sigilo y actuar (Art. 35 LPRL)." },
        { title: "Denuncia Formal Interna", desc: "Presentar el escrito de denuncia (disponible en el Generador) ante el Departamento de RRHH o la Direcci√≥n, solicitando la aplicaci√≥n del protocolo de acoso." },
        { title: "Medidas Cautelares", desc: "Solicitar el cambio de puesto, turno o centro de trabajo (separaci√≥n del acosador) mientras dure la investigaci√≥n, para proteger la salud de la v√≠ctima." },
        { title: "Investigaci√≥n", desc: "La empresa tiene la obligaci√≥n de abrir una investigaci√≥n confidencial e inmediata, escuchar a las partes y testigos, y emitir una resoluci√≥n en el plazo m√°s breve posible." },
        { title: "Actuaci√≥n Sindical y Legal", desc: "Si la empresa no act√∫a o la resoluci√≥n es insatisfactoria, CCOO te acompa√±ar√° a la Inspecci√≥n de Trabajo, interpondr√° denuncia por vulneraci√≥n de derechos fundamentales o iniciar√° el proceso judicial (Art. 50 ET)." },
    ];

    const handleInputChange = useCallback((e) => {
        const { name, value, type, checked } = e.target;
        setRiskForm(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    }, [setRiskForm]);

    const handleSubmit = (e) => {
        e.preventDefault();
        setModalOpen(true);
        // Aqu√≠ se enviar√≠a a Firestore (colecci√≥n 'denuncias_prl') o un servicio de correo/WhatsApp seguro
        console.log("Denuncia/Consulta PRL enviada:", riskForm);
    };

    const InfoBlock = ({ title, content, color }) => (
        <div className={`p-4 rounded-xl shadow-lg border border-${color}-200`} style={{ backgroundColor: color === 'red' ? '#FEF2F2' : '#F9FAFB' }}>
            <h4 className="font-bold text-lg mb-2" style={{ color: color === 'red' ? CCOO_RED : CCOO_GRAY }}>{title}</h4>
            <ul className="list-disc ml-5 space-y-1 text-sm text-gray-700">
                {content.map((item, index) => <li key={index}>{item}</li>)}
            </ul>
        </div>
    );

    const FormularioPRL = useMemo(() => () => (
        <Card title="Formulario de Denuncia de Riesgos (Confidencial)" icon="‚úçÔ∏è">
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700">Ubicaci√≥n del Riesgo (Centro de Trabajo, Puesto)</label>
                    <input type="text" name="location" value={riskForm.location} onChange={handleInputChange} required className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Tipo de Riesgo (F√≠sico, Biol√≥gico, Acoso, Falta de EPI)</label>
                    <input type="text" name="risk" value={riskForm.risk} onChange={handleInputChange} required className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Descripci√≥n Detallada del Incumplimiento/Riesgo</label>
                    <textarea name="description" value={riskForm.description} onChange={handleInputChange} required rows="5" className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Tu Nombre Completo (Si no es an√≥nimo)</label>
                        <input type="text" name="name" value={riskForm.name} onChange={handleInputChange} disabled={riskForm.is_anonymous} className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Tu Tel√©fono</label>
                        <input type="tel" name="phone" value={riskForm.phone} onChange={handleInputChange} disabled={riskForm.is_anonymous} className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                    </div>
                </div>
                <div className="flex items-center">
                    <input type="checkbox" name="is_anonymous" checked={riskForm.is_anonymous} onChange={handleInputChange} id="anonymous-check" className="h-4 w-4 text-red-600 border-gray-300 rounded" />
                    <label htmlFor="anonymous-check" className="ml-2 block text-sm font-medium text-red-700">
                        Enviar de forma **AN√ìNIMA** (Los Delegados lo tramitar√°n).
                    </label>
                </div>
                <IconButton type="submit" className="w-full">
                    Enviar Denuncia a Delegados de Prevenci√≥n
                </IconButton>
            </form>
        </Card>
    ), [riskForm.location, riskForm.risk, riskForm.description, riskForm.name, riskForm.phone, riskForm.is_anonymous, handleInputChange, handleSubmit]);

    return (
        <PageLayout title="Prevenci√≥n de Riesgos Laborales (PRL) y Protocolo de Acoso" logo={true} currentPage="PRL">
            <p className="text-lg mb-6 text-red-700 font-bold flex items-center">
                <span className="text-3xl mr-2">üö®</span>
                PROTOCOLO ACOSO LABORAL: PRIORIDAD ABSOLUTA
            </p>

            <Card title="Protocolo CCOO Acoso Laboral (Paso a Paso)" icon="üö®" className="mb-6 bg-red-50 border-red-300">
                <div className="space-y-4">
                    {PROTOCOL_STEPS.map((step, index) => (
                        <div key={index} className="flex items-start p-3 bg-white rounded-lg shadow-sm border border-red-100">
                            <span className="flex-shrink-0 text-xl font-bold mr-3" style={{ color: CCOO_RED }}>{index + 1}.</span>
                            <div>
                                <h4 className="font-semibold text-red-700">{step.title}</h4>
                                <p className="text-sm text-gray-700">{step.desc}</p>
                            </div>
                        </div>
                    ))}
                </div>
            </Card>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Columna de Informaci√≥n PRL */}
                <div className="space-y-6">
                    <InfoBlock 
                        title="Derechos del Trabajador en PRL" 
                        color="gray"
                        content={[
                            "Protecci√≥n eficaz frente a riesgos (Art. 14 LPRL).",
                            "Informaci√≥n y formaci√≥n adecuadas y continuas (Art. 19 LPRL).",
                            "Consulta y participaci√≥n a trav√©s de Delegados de Prevenci√≥n (Art. 35 LPRL).",
                            "Vigilancia peri√≥dica y voluntaria de la salud (Art. 22 LPRL).",
                            "Paralizaci√≥n de la actividad ante riesgo grave e inminente (Art. 21 LPRL)."
                        ]}
                    />
                    <InfoBlock 
                        title="Equipos de Protecci√≥n y Documentaci√≥n" 
                        color="gray"
                        content={[
                            "Lista de EPIs Obligatorios (Casco, chaleco antibalas, guantes, etc.).",
                            "Protocolos ante emergencias (evacuaci√≥n, primeros auxilios).",
                            "Reconocimientos m√©dicos espec√≠ficos.",
                            "Delegados de Prevenci√≥n y Comit√© de Seguridad y Salud.",
                            "Registro de accidentes e incidentes laborales."
                        ]}
                    />
                    <div className="p-4 rounded-xl shadow-lg border border-red-500 bg-red-100">
                         <h4 className="font-bold text-lg mb-2 text-red-700">Contactos de Emergencia (PRL)</h4>
                         <p className="text-sm text-gray-700">
                            **Delegados de Prevenci√≥n CCOO:** (Ver secci√≥n Contacto)<br/>
                            **INSPECCI√ìN DE TRABAJO:** 901 100 036<br/>
                            **URGENCIAS 112**
                         </p>
                    </div>
                </div>

                {/* Columna de Formulario de Denuncia de Riesgos */}
                <FormularioPRL />
            </div>
            
            <CustomAlert 
                open={modalOpen}
                onClose={() => setModalOpen(false)}
                type="success"
                message={`Tu denuncia de riesgo en ${riskForm.location} ha sido enviada con el c√≥digo √∫nico de seguimiento [SIM-4876]. Nuestros Delegados de Prevenci√≥n la revisar√°n de inmediato. ¬°Gracias por tu colaboraci√≥n!`}
            />
        </PageLayout>
    );
};

// 7. CONTACTO Y AFILIACI√ìN
const Afiliacion = ({ userId, isAuthReady, setNotification }) => {
    const [form, setForm] = useState({
        name: '', email: '', phone: '', employer: '', accepted_terms: false
    });
    const [modalOpen, setModalOpen] = useState(false);
    
    const DELEGADOS = [
        { name: 'Jos√© Ra√∫l Siles', role: 'Secretario de Acci√≥n Sindical', phone: JR_PHONE, wa: JR_PHONE, img: 'https://placehold.co/100x100/DC2626/FFFFFF?text=JR', bio: 'Experto en negociaci√≥n colectiva, despidos y conflictos laborales.' },
        { name: 'Francisco Aguilera', role: 'Secretario Secci√≥n Sindical', phone: FA_PHONE, wa: FA_PHONE, img: 'https://placehold.co/100x100/DC2626/FFFFFF?text=FA', bio: 'Especialista en PRL, vigilancia de la salud y protocolo de acoso.' }
    ];

    const handleInputChange = useCallback((e) => {
        const { name, value, checked, type } = e.target;
        setForm(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
    }, [setForm]);

    const handleSubmit = (e) => {
        e.preventDefault();
        if (!form.accepted_terms) {
            alert("Debes aceptar los t√©rminos para enviar la solicitud.");
            return;
        }
        setModalOpen(true);
        // Aqu√≠ ir√≠a el env√≠o de la solicitud de afiliaci√≥n a Firestore o un servicio de correo
        console.log("Solicitud de Afiliaci√≥n enviada:", form);
        setForm({ name: '', email: '', phone: '', employer: '', accepted_terms: false });
    };

    const VENTAJS = [
        "Asesor√≠a Jur√≠dica gratuita especializada.",
        "Defensa legal en despidos, sanciones y reclamaci√≥n de cantidades.",
        "Acceso preferente a formaci√≥n y cursos de reciclaje.",
        "Respaldo sindical en conflictos individuales y colectivos.",
        "Informaci√≥n actualizada del Convenio y cambios legislativos.",
        "Participaci√≥n en la toma de decisiones del sector."
    ];
    
    const CuotaCalculator = () => {
        const [salary, setSalary] = useState(1500);
        const cuota = useMemo(() => salary * 0.01 + 5, [salary]); // Simulaci√≥n: 1% del salario + 5‚Ç¨ fijos
        return (
            <Card title="Calculadora de Cuota Sindical (Estimada)" icon="üßÆ">
                <label className="block text-sm font-medium text-gray-700">Salario Mensual Estimado (‚Ç¨)</label>
                <input 
                    type="range" 
                    min="1200" 
                    max="2500" 
                    value={salary} 
                    onChange={(e) => setSalary(Number(e.target.value))} 
                    className="w-full h-2 bg-red-100 rounded-lg appearance-none cursor-pointer range-lg text-red-600"
                    style={{'--tw-ring-color': CCOO_RED}}
                />
                <p className="text-center font-bold text-2xl mt-4">
                    Cuota Estimada: <span style={{ color: CCOO_RED }}>{cuota.toFixed(2)} ‚Ç¨/mes</span>
                </p>
                <p className="text-xs text-gray-500 mt-1">
                    (Base: {salary} ‚Ç¨). Las cuotas son deducibles en la Declaraci√≥n de la Renta.
                </p>
            </Card>
        );
    };

    const FormularioAfiliacion = useMemo(() => () => (
        <Card title="Solicitud de Afiliaci√≥n Online" icon="‚úçÔ∏è" className="lg:col-span-2">
            <p className="text-sm text-gray-600 mb-4">
                Rellena el formulario y nos pondremos en contacto contigo para finalizar el proceso de afiliaci√≥n de forma confidencial.
            </p>
            <form onSubmit={handleSubmit} className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" name="name" value={form.name} onChange={handleInputChange} required className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" value={form.email} onChange={handleInputChange} required className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-700">Tel√©fono</label>
                        <input type="tel" name="phone" value={form.phone} onChange={handleInputChange} required className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                    </div>
                </div>
                <div>
                    <label className="block text-sm font-medium text-gray-700">Empresa de Seguridad</label>
                    <input type="text" name="employer" value={form.employer} onChange={handleInputChange} required placeholder="Ej: PROSEGUR, SECURITAS, etc." className="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-2 border" />
                </div>

                <div className="p-4 rounded-xl shadow-inner bg-red-50 border border-red-200">
                    <h4 className="font-bold text-red-700 mb-2">Ventajas Clave de Afiliarse</h4>
                    <ul className="list-disc ml-5 text-sm text-gray-700 space-y-1">
                        {VENTAJS.map((v, i) => <li key={i}>{v}</li>)}
                    </ul>
                </div>

                <div className="flex items-center">
                    <input type="checkbox" name="accepted_terms" checked={form.accepted_terms} onChange={handleInputChange} required id="terms-check" className="h-4 w-4 text-red-600 border-gray-300 rounded" />
                    <label htmlFor="terms-check" className="ml-2 block text-sm font-medium text-gray-700">
                        Acepto la Pol√≠tica de Privacidad y deseo que CCOO me contacte para formalizar mi afiliaci√≥n.
                    </label>
                </div>

                <IconButton type="submit" className="w-full">
                    Enviar Solicitud de Contacto
                </IconButton>
            </form>
        </Card>
    ), [form, handleInputChange, handleSubmit]);

    return (
        <PageLayout title="Contacto y Afiliaci√≥n CCOO Vigilantes" logo={true} currentPage="Afiliacion">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* Columna de Contacto Delegados */}
                <div className="lg:col-span-1 space-y-6">
                    <Card title="Delegados Clave" icon="üë•">
                        {DELEGADOS.map(d => (
                            <div key={d.name} className="p-4 border rounded-xl shadow-md mb-4 flex items-start bg-red-50">
                                <img src={d.img} alt={d.name} className="w-16 h-16 rounded-full mr-4 object-cover border-2 border-red-400"/>
                                <div>
                                    <h4 className="font-bold text-red-700">{d.name}</h4>
                                    <p className="text-sm text-gray-700 font-medium mb-2">{d.role}</p>
                                    <div className="flex space-x-2">
                                        <a href={`tel:${d.phone}`} className="text-xs px-2 py-1 rounded-full bg-red-700 text-white hover:bg-red-800 flex items-center">
                                            üìû Llamar
                                        </a>
                                        <a href={`https://wa.me/${d.wa}`} target="_blank" className="text-xs px-2 py-1 rounded-full bg-green-500 text-white hover:bg-green-600 flex items-center">
                                            üí¨ WhatsApp
                                        </a>
                                    </div>
                                </div>
                            </div>
                        ))}
                        <div className="mt-4 p-3 border rounded-xl shadow-sm text-sm bg-gray-50">
                            <h4 className="font-bold text-gray-700 mb-1">Oficinas CCOO Cercanas</h4>
                            <p className="text-gray-600">
                                Localiza tu sede provincial de CCOO en el buscador oficial de la Confederaci√≥n.
                            </p>
                            <a href="https://www.ccoo.es/contacta" target="_blank" className="text-red-700 hover:underline text-xs font-semibold">Buscar mi Sede &rarr;</a>
                        </div>
                    </Card>
                    <CuotaCalculator />
                </div>

                {/* Columna de Formulario de Afiliaci√≥n */}
                <FormularioAfiliacion />
            </div>
            
            <CustomAlert 
                open={modalOpen}
                onClose={() => setModalOpen(false)}
                type="success"
                message="¬°Solicitud de afiliaci√≥n enviada! En breve, Jos√© Ra√∫l o Francisco se pondr√°n en contacto contigo. Gracias por unirte a CCOO."
            />
        </PageLayout>
    );
};


// --- COMPONENTE PRINCIPAL DE LA APLICACI√ìN ---

const App = () => {
  const [currentPage, setCurrentPage] = useState('Home');
  const [notification, setNotification] = useState({ message: '', type: 'info', open: false });
  const { userId, isAuthReady, auth, db } = useFirebaseAuth();

  const navigate = (page) => setCurrentPage(page);

  const renderPage = () => {
    const props = { navigate, userId, isAuthReady, setNotification };

    switch (currentPage) {
      case 'Nominas':
        return <Nominas {...props} />;
      case 'Citas':
        return <Citas {...props} />;
      case 'Escritos':
        return <Escritos {...props} />;
      case 'FAQ':
        return <FAQ {...props} />;
      case 'PRL':
        return <PRL {...props} />;
      case 'Afiliacion':
        return <Afiliacion {...props} />;
      case 'Turnos':
        return <Turnos {...props} />;
      case 'Indemnizaciones':
        return <Indemnizaciones {...props} />;
      case 'Documental':
        return <Documental {...props} />;
      case 'Convenio':
        return <Convenio {...props} />;
      case 'Home':
      default:
        return <Home {...props} />;
    }
  };

  const navItems = [
    { name: 'Inicio', page: 'Home' },
    { name: 'Citas', page: 'Citas' },
    { name: 'N√≥minas', page: 'Nominas' },
    { name: 'Escritos', page: 'Escritos' },
    { name: 'FAQ', page: 'FAQ' },
    { name: 'PRL/Acoso', page: 'PRL' },
    { name: 'Afiliaci√≥n', page: 'Afiliacion' },
  ];

  if (!isAuthReady) {
    return <PageLayout title="Cargando Plataforma..." logo={true}><p className="text-center text-lg mt-10">Conectando con el servidor sindical (autenticaci√≥n)...</p></PageLayout>;
  }

  return (
    <>
      <PageLayout 
        title="Jos√© Ra√∫l Siles y Francisco Aguilera | CCOO Vigilantes"
        logo={false}
        bgColorClass="bg-gray-50"
        navigate={navigate}
        currentPage={currentPage} // Pasar la p√°gina actual para el bot√≥n de retroceso
        actions={
          <nav className="flex space-x-2 overflow-x-auto pb-1 -mb-1 lg:w-auto">
            {navItems.map(item => (
              <button
                key={item.page}
                onClick={() => navigate(item.page)}
                className={`px-3 py-1.5 rounded-xl font-semibold transition-colors text-sm shadow-md flex-shrink-0 ${currentPage === item.page ? 'bg-red-700 text-white ring-2 ring-red-900' : 'bg-white text-gray-700 hover:bg-gray-100'}`}
              >
                {item.name}
              </button>
            ))}
          </nav>
        }
      >
        {renderPage()}
      </PageLayout>
      <CustomAlert 
        open={notification.open}
        message={notification.message}
        type={notification.type}
        onClose={() => setNotification({ ...notification, open: false })}
      />
    </>
  );
};

// Renderizar la aplicaci√≥n
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

    </script>
</body>
</html>
